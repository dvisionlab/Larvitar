<!DOCTYPE html>
<html class="h-100 overflow-hidden">
  <head>
    <meta charset="UTF-8" />

    <link
      rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/vs2015.min.css"
    />
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js"></script>
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
    />

    <!-- Bootstrap JS and Popper.js (required for some Bootstrap components) -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <style>
      .buttonbar {
        background-color: #f4f4f4;
        padding: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
      }
      .buttonbar > * {
        margin-right: 5px;
      }
      .loader {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #3498db;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 3px;
      }

      /* Adjust the styling for the other elements as needed */
      .button {
        padding: 10px;
        font-size: 16px;
      }

      .manualInput {
        width: 100px;
        padding: 8px;
        font-size: 14px;
      }
      .custom-width {
        width: calc(1% - 1px); /* Adjust the width as needed */
      }
    </style>
    <script>
      hljs.highlightAll();
    </script>
    <title>Larvitar - Default Tools example</title>
  </head>

  <body class="h-100" style="background-color: #000000">
    <div class="container">
      <div id="buttonBar" class="row" style="display: none">
        <div id="loaderDiv" class="col">
          <div class="loader" id="loader"></div>
        </div>

        <!-- Bootstrap grid system for alignment -->
        <div id="toggleButtonDiv" class="col">
          <button id="toggleButton" class="btn btn-primary">
            Current Image
          </button>
        </div>

        <div id="masksNumberDiv" class="col">
          <input
            type="number"
            class="form-control manualInput"
            id="masksNumber"
            placeholder="NÂ° Masks"
          />
        </div>

        <div id="startImageDiv" class="col">
          <input
            type="number"
            class="form-control manualInput"
            id="startImage"
            placeholder="startImage"
            style="display: none"
          />
        </div>

        <div id="endImageDiv" class="col">
          <input
            type="number"
            class="form-control manualInput"
            id="endImage"
            placeholder="endImage"
            style="display: none"
          />
        </div>
      </div>
    </div>
    <div class="row h-100">
      <div id="viewer" class="col-8 h-100" style="background-color: black">
        <p style="position: absolute; color: white; top: 0">
          Press "t" to cycle through tools<br />
        </p>
        <p id="active-tool" style="position: absolute; top: 20px; color: white">
          Active Tool: Brush<br />
        </p>
        <p id="info" style="position: absolute; top: 40px; color: white"></p>
      </div>

      <div class="col-4 h-100">
        <pre class="h-100">
          <code class="javascript" style="background-color: #000000">
          <p style="font-size:0.6vw;">
            function triggerHandleToggle() {
                let isMultiImage =
                  larvitar.DEFAULT_TOOLS["WSToggle"].configuration.multiImage === false
                    ? true
                    : false;
                larvitar.DEFAULT_TOOLS["WSToggle"].configuration.multiImage =
                  isMultiImage;
                console.log(isMultiImage);
              }
              const masksNumberInput = document.getElementById("masksNumber");
              // Add an input event listener
              masksNumberInput.addEventListener("input", function (event) {
                // Update the variable with the input value
                larvitar.DEFAULT_TOOLS["WSToggle"].configuration.masksNumber =
                  event.target.value;
              });
              const startInput = document.getElementById("startImage");
              // Add an input event listener
              startInput.addEventListener("input", function (event) {
                // Update the variable with the input value
                console.log("Start", event.target.value);
                larvitar.DEFAULT_TOOLS["WSToggle"].configuration.startIndex =
                  event.target.value;
              });
              const endInput = document.getElementById("endImage");
              // Add an input event listener
              endInput.addEventListener("input", function (event) {
                // Update the variable with the input value
                console.log("end", event.target.value);
                larvitar.DEFAULT_TOOLS["WSToggle"].configuration.endIndex =
                  event.target.value;
              });
              // Attach click event to the button
              const toggleButton = document.getElementById("toggleButton");
              toggleButton.addEventListener("click", triggerHandleToggle);
        
              let demoFiles = [];
              let counter = 0;
        
              const getDemoFileNames = function () {
                let demoFileList = [];
                for (let i = 1; i < 25; i++) {
                  let filename = "anon" + i;
                  demoFileList.push(filename);
                }
                return demoFileList;
              };
        
              // init all
              larvitar.initializeImageLoader();
              larvitar.initializeCSTools();
              larvitar.store.initialize();
              larvitar.store.addViewport("viewer");
              larvitar.registerNRRDImageLoader();
              larvitar.initSegmentationModule();
        
              async function createFile(fileName, cb) {
                let response = await fetch("./demo/" + fileName);
                let data = await response.blob();
                let file = new File([data], fileName);
                demoFiles.push(file);
                counter++;
                if (counter == 24) {
                  cb();
                }
              }
        
              async function renderSerie() {
                larvitar.resetLarvitarManager();
                larvitar
                  .readFiles(demoFiles)
                  .then(seriesStack => {
                    console.log(seriesStack);
                    // render the first series of the study
                    let seriesId = _.keys(seriesStack)[0];
                    let serie = seriesStack[seriesId];
                    larvitar.renderImage(serie, "viewer").then(() => {
                      console.log("Image has been rendered");
                    });
                    // optionally cache the series
                    larvitar.populateLarvitarManager(seriesId, serie);
        
                    larvitar
                      .cacheImages(serie, function (resp) {
                        if (resp.loading == 100) {
                          let cache = larvitar.cornerstone.imageCache;
                          console.log(
                            "Cache size: ",
                            cache.getCacheInfo().cacheSizeInBytes / 1e6,
                            "Mb"
                          );
                        }
                      })
                      .then(() => {
                        setTimeout(function () {
                          console.log("Cache has been loaded. Calling loadMasks.");
                          larvitar.addDefaultTools();
                          larvitar.setToolActive("Brush");
                          loadMasks();
                        }, 3000);
                      });
                    let mouseConfig = {
                      mouse_button_right: {
                        ctrl: "Pan",
                        default: "Zoom"
                      },
                      debug: true
                    };
        
                    // NOTE: this also activate the tools marked as default for each mouse button
                    larvitar.addMouseKeyHandlers(mouseConfig);
                  })
                  .catch(err => console.error(err));
              }
        
              async function loadMasks() {
                console.log("loadMasks() called");
                let data = new Int16Array(768 * 768 * 24); //fix dimensions based on loaded images dimensions
                let properties = {
                  // color: "#00ff00",
                  opacity: 0.2,
                  labelId: 0
                };
                // add to viewport
                await larvitar
                  .addSegmentationMask(properties, data, "viewer")
                  .then(() => {
                    // activate brush on this labelmap
                    larvitar.setActiveLabelmap(0, "viewer");
                  });
              }
        
              let demoFileList = getDemoFileNames();
              _.each(demoFileList, function (demoFile) {
                createFile(demoFile, renderSerie);
              });
              let element = document.getElementById("viewer");
              let tool_counter = 0;
              let tool;
              document.onkeypress = function (e) {
                e = e || window.event;
                if (e.keyCode == 116 || e.keyCode == 84) {
                  if (tool != undefined) {
                    //clearToolData(element, tool);
                  }
                  const selectedNames = [
                    "Brush",
                    "ThresholdsBrush",
                    "RectangleScissors",
                    "FreehandScissors",
                    "CircleScissors",
                    "CorrectionScissors",
                    "PolylineScissors",
                    "WSToggle"
                  ]; // Replace with your selected names
                  const selectedTools = _.filter(larvitar.DEFAULT_TOOLS, tool =>
                    _.includes(selectedNames, tool.name)
                  );
        
                  const tools = _.map(selectedTools, "name");
        
                  let increment = e.shiftKey ? -1 : 1;
                  tool_counter =
                    tool_counter == tools.length - 1 ? 0 : tool_counter + increment;
                  tool_counter = tool_counter < 0 ? 0 : tool_counter;
                  tool = tools[tool_counter];
        
                  larvitar.setToolActive(tool);
                  if (tool === "WSToggle") {
                    document.getElementById("info").innerHTML =
                      "click on the feature of interest to apply watershed segmentation<br>";
                    buttonBar.style.display = "block"; // make it visible
                    loader.style.display = "none";
                    element.addEventListener("click", rotateLoader);
                  } else {
                    document.getElementById("info").innerHTML = "<br>";
                    buttonBar.style.display = "none"; // make it invisible
                    element.removeEventListener("click", rotateLoader);
                  }
                  $("#active-tool").html("Active Tool: " + tool);
                }
              };
              /*function clearToolData(element, toolName) {
                const toolData = larvitar.cornerstoneTools.getToolState(
                  element,
                  toolName
                );
                console.log(element);
                console.log(toolName);
                console.log(toolData);
                if (toolData && toolData.data && toolData.data.length > 0) {
                  toolData.data.forEach(data => {
                    data.visible = false;
                  });
                }
              }*/
          </p>
          </code>
        </pre>
      </div>
    </div>

    <script src="./larvitar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script
      src="https://code.jquery.com/jquery-3.6.0.slim.min.js"
      integrity="sha256-u7e5khyithlIdTpu22PHhENmPcRdFiHRjhAuHcs05RI="
      crossorigin="anonymous"
    ></script>
    <script>
      function onOpenCvReady() {
        console.log("OpenCV Ready", cv);
      }
    </script>
    <script>
      const loader = document.getElementById("loader");
      let rotation = 0;

      function rotateLoader() {
        loader.style.display = "block";

        if (larvitar.DEFAULT_TOOLS["WSToggle"].configuration.onload) {
          rotation += 10; // You can adjust the rotation speed
          loader.style.transform = `rotate(${rotation}deg)`;
          requestAnimationFrame(rotateLoader);
        } else {
          loader.style.display = "none";
        }
      }

      //rotateLoader();
    </script>
    <script
      src="https://docs.opencv.org/4.5.4/opencv.js"
      onload="onOpenCvReady();"
      type="text/javascript"
    ></script>

    <script>
      function triggerHandleToggle() {
        let isMultiImage =
          larvitar.DEFAULT_TOOLS["WSToggle"].configuration.multiImage === false
            ? true
            : false;
        larvitar.DEFAULT_TOOLS["WSToggle"].configuration.multiImage =
          isMultiImage;
        toggleButton.innerHTML =
          isMultiImage === true ? "Multi Image" : "Current Image";
        startInput.style.display = isMultiImage === true ? "block" : "none";
        endInput.style.display = isMultiImage === true ? "block" : "none";
      }
      const masksNumberInput = document.getElementById("masksNumber");
      // Add an input event listener
      masksNumberInput.addEventListener("input", function (event) {
        // Update the variable with the input value
        larvitar.DEFAULT_TOOLS["WSToggle"].configuration.masksNumber =
          event.target.value;
      });
      const startInput = document.getElementById("startImage");
      // Add an input event listener
      startInput.addEventListener("input", function (event) {
        // Update the variable with the input value
        console.log("Start", event.target.value);
        larvitar.DEFAULT_TOOLS["WSToggle"].configuration.startIndex =
          event.target.value;
      });
      const endInput = document.getElementById("endImage");
      // Add an input event listener
      endInput.addEventListener("input", function (event) {
        // Update the variable with the input value
        console.log("end", event.target.value);
        larvitar.DEFAULT_TOOLS["WSToggle"].configuration.endIndex =
          event.target.value;
      });
      // Attach click event to the button
      const toggleButton = document.getElementById("toggleButton");
      toggleButton.addEventListener("click", triggerHandleToggle);
      const buttonDiv = document.getElementById("toggleButtonDiv");
      const loaderDiv = document.getElementById("loaderDiv");
      const startDiv = document.getElementById("startImageDiv");
      const endDiv = document.getElementById("endImageDiv");
      const maskDiv = document.getElementById("masksNumberDiv");
      let demoFiles = [];
      let counter = 0;

      const getDemoFileNames = function () {
        let demoFileList = [];
        for (let i = 1; i < 25; i++) {
          let filename = "anon" + i;
          demoFileList.push(filename);
        }
        return demoFileList;
      };

      // init all
      larvitar.initializeImageLoader();
      larvitar.initializeCSTools();
      larvitar.store.initialize();
      larvitar.store.addViewport("viewer");
      larvitar.registerNRRDImageLoader();
      larvitar.initSegmentationModule();

      async function createFile(fileName, cb) {
        let response = await fetch("./demo/" + fileName);
        let data = await response.blob();
        let file = new File([data], fileName);
        demoFiles.push(file);
        counter++;
        if (counter == 24) {
          cb();
        }
      }

      async function renderSerie() {
        larvitar.resetLarvitarManager();
        larvitar
          .readFiles(demoFiles)
          .then(seriesStack => {
            console.log(seriesStack);
            // render the first series of the study
            let seriesId = _.keys(seriesStack)[0];
            let serie = seriesStack[seriesId];
            larvitar.renderImage(serie, "viewer").then(() => {
              console.log("Image has been rendered");
            });
            // optionally cache the series
            larvitar.populateLarvitarManager(seriesId, serie);

            larvitar
              .cacheImages(serie, function (resp) {
                if (resp.loading == 100) {
                  let cache = larvitar.cornerstone.imageCache;
                  console.log(
                    "Cache size: ",
                    cache.getCacheInfo().cacheSizeInBytes / 1e6,
                    "Mb"
                  );
                }
              })
              .then(() => {
                setTimeout(function () {
                  console.log("Cache has been loaded. Calling loadMasks.");
                  larvitar.addDefaultTools();
                  larvitar.setToolActive("Brush");
                  loadMasks();
                }, 3000);
              });
            let mouseConfig = {
              mouse_button_right: {
                ctrl: "Pan",
                default: "Zoom"
              },
              debug: true
            };

            // NOTE: this also activate the tools marked as default for each mouse button
            larvitar.addMouseKeyHandlers(mouseConfig);
          })
          .catch(err => console.error(err));
      }

      async function loadMasks() {
        console.log("loadMasks() called");
        let data = new Int16Array(768 * 768 * 24); //fix dimensions based on loaded images dimensions
        let properties = {
          // color: "#00ff00",
          opacity: 0.2,
          labelId: 0
        };
        // add to viewport
        await larvitar
          .addSegmentationMask(properties, data, "viewer")
          .then(() => {
            // activate brush on this labelmap
            larvitar.setActiveLabelmap(0, "viewer");
          });
      }

      let demoFileList = getDemoFileNames();
      _.each(demoFileList, function (demoFile) {
        createFile(demoFile, renderSerie);
      });
      let element = document.getElementById("viewer");
      let tool_counter = 0;
      let tool;
      document.onkeypress = function (e) {
        e = e || window.event;
        if (e.keyCode == 116 || e.keyCode == 84) {
          if (tool != undefined) {
            //clearToolData(element, tool);
          }
          const selectedNames = [
            "Brush",
            "RectangleScissors",
            "FreehandScissors",
            "CircleScissors",
            "CorrectionScissors",
            "PolylineScissors",
            "WSToggle"
          ]; // Replace with your selected names
          const selectedTools = _.filter(larvitar.DEFAULT_TOOLS, tool =>
            _.includes(selectedNames, tool.name)
          );

          const tools = _.map(selectedTools, "name");

          let increment = e.shiftKey ? -1 : 1;
          tool_counter =
            tool_counter == tools.length - 1 ? 0 : tool_counter + increment;
          tool_counter = tool_counter < 0 ? 0 : tool_counter;
          tool = tools[tool_counter];

          larvitar.setToolActive(tool);
          if (tool === "WSToggle") {
            document.getElementById("info").innerHTML =
              "<b>ctrl+mouse wheel to change brush radius</b><br />" +
              "<b>click to activate watershed segmentation of features with greyscale " +
              "value of interest</b><br />" +
              "<b>ctrl+click for Label Eraser:</b> erases selected label<br />" +
              "<b>alt+click for LabelPicker: </b>allows you to pick a label, click again to " +
              "apply the picked label<br />" +
              "<b>shift+click+drag for Manual Eraser</b>";

            buttonBar.style.removeProperty("display"); // make it visible
            //TODO: do not use block, delete display parameter from style instead
            //to make it return to boostrap's default (flex)
            //remove flex grow for
            loader.style.display = "none";
            console.log(maskDiv.style);
            maskDiv.style.flexGrow = 0;
            loaderDiv.style.flexGrow = 0;
            startDiv.style.flexGrow = 0;
            endDiv.style.flexGrow = 0;
            buttonDiv.style.flexGrow = 0;
            element.addEventListener("click", rotateLoader);
          } else {
            document.getElementById("info").innerHTML = "<br>";
            buttonBar.style.display = "none"; // make it invisible
            element.removeEventListener("click", rotateLoader);
          }
          $("#active-tool").html("Active Tool: " + tool);
        }
      };
      /*function clearToolData(element, toolName) {
        const toolData = larvitar.cornerstoneTools.getToolState(
          element,
          toolName
        );
        console.log(element);
        console.log(toolName);
        console.log(toolData);
        if (toolData && toolData.data && toolData.data.length > 0) {
          toolData.data.forEach(data => {
            data.visible = false;
          });
        }
      }*/
    </script>
  </body>
</html>
