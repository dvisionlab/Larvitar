<!DOCTYPE html>
<html class="h-100 overflow-hidden">
  <head>
    <meta charset="UTF-8" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/vs2015.min.css"
    />
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js"></script>
    <script>
      hljs.highlightAll();
    </script>
    <script>
      // Check the host and set the script source dynamically
      const script = document.createElement("script");

      if (window.location.host === "larvitar.dvisionlab.com") {
        document.write(
          '<script src="https://larvitar.dvisionlab.com/assets/larvitar.js"><\/script>'
        );
        console.log("Using the script from the CDN");
      } else {
        document.write('<script src="../../dist/larvitar.js"><\/script>');
        console.log("Using the local script");
      }
      // Append the script to the document
      document.head.appendChild(script);
    </script>
    <title>Larvitar - Basic rendering example</title>
    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
      }
      * {
        box-sizing: border-box;
      }
      label {
        color: #28b47f;
        font-weight: bold;
        text-align: center;
        border: 2px;
      }
      /* Button used to open the contact form - fixed at the bottom of the page */
      .open-button {
        background-color: #28b47f;
        color: white;
        padding: 16px 20px;
        border: none;
        cursor: pointer;
        opacity: 0.8;
        position: absolute;
        top: 30px;
      }

      /* The popup form - hidden by default */
      .form-popup {
        display: none;
        position: absolute;
        top: 30px;
        border: 3px solid #555;
        z-index: 9;
      }

      /* Add styles to the form container */
      .form-container {
        max-width: 300px;
        padding: 10px;
        background-color: rgb(0, 0, 0);
      }

      /* Full-width input fields */
      .form-container input[type="text"],
      .form-container input[type="password"] {
        width: 100%;
        padding: 15px;
        margin: 5px 0 22px 0;
        border: none;
        background: #f1f1f1;
      }

      /* When the inputs get focus, do something */
      .form-container input[type="text"]:focus,
      .form-container input[type="password"]:focus {
        background-color: #ddd;
        outline: none;
      }

      /* Set a style for the submit/login button */
      .form-container .btn {
        background-color: #04aa6d;
        color: white;
        padding: 16px 20px;
        border: none;
        cursor: pointer;
        width: 100%;
        margin-bottom: 10px;
        opacity: 0.8;
      }

      /* Add a red background color to the cancel button */
      .form-container .cancel {
        background-color: red;
      }

      /* Add some hover effects to buttons */
      .form-container .btn:hover,
      .open-button:hover {
        opacity: 1;
      }

      #viewer.dragover {
        background-color: #d8eaff;
        color: #0056b3;
      }

      /* Spinner styling */
      #spinner {
        display: none; /* Hidden by default */
        position: fixed;
        top: 50%;
        left: 40%;
        transform: translate(-50%, -50%);
        border: 8px solid #f3f3f3;
        border-top: 8px solid #007bff;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        z-index: 1000; /* Ensure it's on top */
      }

      /* Spinner animation */
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>

  <body class="h-100" style="background-color: #000000">
    <div class="row h-100">
      <div id="viewer" class="col-8 h-100" style="background-color: black">
        <p style="position: absolute; color: white">
          <b>Open form:</b> Allows to modify DICOM tags and download the
          modified image/images
        </p>
        <p style="position: absolute; top: 20px; color: white">
          <b
            >Drag and drop a folder or a list of dicom files to visualize in the
            current viewer</b
          >
        </p>
        <button
          class="open-button"
          style="position: absolute; top: 50px"
          onclick="openForm()"
        >
          Open Form
        </button>

        <button
          class="open-button"
          style="position: absolute; left: 125px; top: 50px"
          onclick="getMetadata()"
        >
          Display Metadata
        </button>

        <button
          class="open-button"
          id="previous"
          style="position: absolute; left: 293px; top: 50px"
          onclick="previousImage()"
        >
          Previous Series <-
        </button>

        <button
          class="open-button"
          id="next"
          style="position: absolute; left: 468px; top: 50px"
          onclick="nextImage()"
        >
          Next Series ->
        </button>

        <div class="form-popup" id="myForm">
          <form id="myFormSub" class="form-container">
            <h1 style="text-align: center; color: #28b47f; font-weight: bold">
              Metadata
            </h1>
            <div id="metadata" style="overflow-y: scroll; height: 300px"></div>
            <div>
              <input type="checkbox" id="downloadCheck" />
              <label> Download modified image/images</label><br />
              <label style="display: none" id="downloadLabel"
                >Download image N:</label
              >
              <input
                type="number"
                id="downloadInput"
                style="display: none"
                placeholder="Download all images"
              />
            </div>
            <button id="submit" class="btn">submit</button>
            <button type="button" class="btn cancel" onclick="closeForm()">
              Close
            </button>
          </form>
        </div>

        <div id="metadataModal" class="modal">
          <table id="metadataTable">
            <thead>
              <tr>
                <th>Tag</th>
                <th>Name</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody>
              <!-- Rows will be added here dynamically -->
            </tbody>
          </table>
        </div>
        <div id="spinner"></div>
      </div>

      <div class="col-4 h-100">
        <pre class="h-100">
          <code class="javascript" style="background-color: #000000">
          <p style="font-size:0.6vw;">
            let demoFiles = [];
            let counter = 0;

            const getDemoFileNames = function () {
              let demoFileList = [];
              for (let i = 1; i < 25; i++) {
                let filename = "anon" + i;
                demoFileList.push(filename);
              }
              return demoFileList;
            };

            // init all
            larvitar.initializeImageLoader();
            larvitar.initializeCSTools();
            larvitar.store.initialize();
            larvitar.store.addViewport("viewer");

            async function createFile(fileName, cb) {
              let response = await fetch("./demo/" + fileName);
              let data = await response.blob();
              let file = new File([data], fileName);
              demoFiles.push(file);
              counter++;
              if (counter == 24) {
                cb();
              }
            }

            function renderSerie() {
              larvitar.resetLarvitarManager();
              larvitar
                .readFiles(demoFiles)
                .then(seriesStack => {
                  // render the first series of the study
                  let seriesId = _.keys(seriesStack)[0];
                  let serie = seriesStack[seriesId];
                  larvitar.renderImage(serie, "viewer").then(() => {
                    console.log("Image has been rendered");
                  });
                  // optionally cache the series
                  larvitar.populateLarvitarManager(seriesId, serie);
                  larvitar.cacheImages(serie, function (resp) {
                    if (resp.loading == 100) {
                      let cache = larvitar.cornerstone.imageCache;
                      console.log(
                        "Cache size: ",
                        cache.getCacheInfo().cacheSizeInBytes / 1e6,
                        "Mb"
                      );
                    }
                  });
                  larvitar.addDefaultTools();
                  larvitar.setToolActive("Wwwc");
                })
                .catch(err => console.log(err));
            }

            let demoFileList = getDemoFileNames();
            _.each(demoFileList, function (demoFile) {
              createFile(demoFile, renderSerie);
            });
          </p>
          </code>
        </pre>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>

    <script>
      let demoFiles = [];
      let newMetaData = {};
      let series;
      let totalFiles = 0;
      let processedFiles = 0;

      const dropCanvas = document.getElementById("viewer");
      const spinner = document.getElementById("spinner");

      // Prevent default behavior for drag-and-drop events
      ["dragenter", "dragover", "dragleave", "drop"].forEach(eventName => {
        dropCanvas.addEventListener(eventName, e => e.preventDefault());
      });

      // Add dragover and dragleave event listeners to style the canvas
      dropCanvas.addEventListener("dragover", () => {
        dropCanvas.classList.add("dragover");
      });

      dropCanvas.addEventListener("dragleave", () => {
        dropCanvas.classList.remove("dragover");
      });

      dropCanvas.addEventListener("drop", e => {
        demoFiles = [];
        totalFiles = 0;
        processedFiles = 0;
        showSpinner(); // Show the spinner
        dropCanvas.classList.remove("dragover");
        const items = e.dataTransfer.items;
        if (items) {
          for (let i = 0; i < items.length; i++) {
            const item = items[i].webkitGetAsEntry();
            if (item) {
              traverseFileTree(item);
            }
          }
        }
      });

      // Function to traverse files in folders
      function traverseFileTree(item) {
        if (item.isFile & (item.name.startsWith(".") == false)) {
          totalFiles++;
          item.file(file => {
            handleFile(file);
          });
        } else if (item.isDirectory) {
          const dirReader = item.createReader();
          readAllEntries(dirReader);
        }
      }

      // Helper function to read all entries in a directory (to handle the 100-item limit)
      function readAllEntries(dirReader, path) {
        dirReader.readEntries(entries => {
          if (entries.length > 0) {
            entries.forEach(entry => {
              traverseFileTree(entry); // Recursively read entries
            });
            // Continue reading entries if there might be more
            readAllEntries(dirReader);
          }
        });
      }

      // Function to handle individual files
      function handleFile(file) {
        demoFiles.push(file);
        processedFiles++;
        if (processedFiles === totalFiles) {
          processFileList(demoFiles); // Call the function when all files are processed
        }
      }

      // Function to handle the full list once it's ready
      function processFileList(demoFiles) {
        renderSerie();
      }

      // Show spinner
      function showSpinner() {
        spinner.style.display = "block";
      }

      // Hide spinner
      function hideSpinner() {
        spinner.style.display = "none";
      }

      var form = document.getElementById("myFormSub");
      function handleForm(event) {
        event.preventDefault();
      }
      form.addEventListener("submit", handleForm);
      function openForm() {
        document.getElementById("myForm").style.display = "block";
      }

      function closeForm() {
        document.getElementById("myForm").style.display = "none";
      }
      const inputBtn = document.getElementById("submit");
      inputBtn.addEventListener("click", func);

      function func() {
        if (series) {
          const keys = Object.keys(
            series.instances[series.imageIds[0]].metadata
          ).filter(item => item.startsWith("x"));

          for (key in keys) {
            if (
              document.getElementById(keys[key]) != undefined &&
              document.getElementById(keys[key]) != null &&
              typeof series.instances[series.imageIds[0]].metadata[
                keys[key]
              ] === "string" &&
              document.getElementById(keys[key]).value &&
              document.getElementById(keys[key]).value !==
                document.getElementById(keys[key]).placeholder
            ) {
              let value = document.getElementById(keys[key]).value;
              newMetaData[keys[key]] = value;
            }
          }
          if (Object.keys(newMetaData) != 0) {
            larvitar.customizeByteArray(series, newMetaData);
          }

          if (document.getElementById("downloadCheck").checked) {
            if (document.getElementById("downloadInput").value) {
              var blob = new Blob(
                [
                  series.instances[
                    series.imageIds[
                      parseInt(
                        document.getElementById("downloadInput").value,
                        10
                      )
                    ]
                  ].dataSet.byteArray
                ],
                {
                  type: "application/dicom"
                }
              );
              var url = window.URL.createObjectURL(blob);
              window.open(url);
              window.URL.revokeObjectURL(url);
            } else {
              for (let i = 0; i < series.imageIds.length; i++) {
                var blob = new Blob(
                  [series.instances[series.imageIds[i]].dataSet.byteArray], //[series.instances[series.imageIds[i]].dataSet.byteArray]
                  {
                    type: "application/dicom"
                  }
                );
                var url = window.URL.createObjectURL(blob);
                window.open(url);
                window.URL.revokeObjectURL(url);
              }
            }
          }
        }
      }
      document.getElementById("downloadCheck").addEventListener("click", () => {
        if (document.getElementById("downloadCheck").checked) {
          document.getElementById("downloadLabel").style.display = "block";
          document.getElementById("downloadInput").style.display = "block";
          document.getElementById("downloadInput").style.width = "250px";
          document.getElementById("downloadInput").min = 0;
          document.getElementById("downloadInput").max =
            series.imageIds.length - 1;
        } else {
          document.getElementById("downloadLabel").style.display = "none";
          document.getElementById("downloadInput").style.display = "none";
        }
      });
      let keys = [];
      const getDemoFileNames = function () {
        let demoFileList = [];
        for (let i = 1; i < 25; i++) {
          let filename = "anon" + i;
          demoFileList.push(filename);
        }
        return demoFileList;
      };

      // init all
      larvitar.initializeImageLoader();
      larvitar.registerMultiFrameImageLoader();
      larvitar.initializeCSTools();
      larvitar.store.initialize();
      larvitar.store.addViewport("viewer");

      async function createFile(fileName, cb) {
        let response = await fetch("./demo/" + fileName);
        let data = await response.blob();
        let file = new File([data], fileName);
        demoFiles.push(file);
        processedFiles++;
        if (processedFiles == 24) {
          cb();
        }
      }

      function getMetadata() {
        const modal = document.getElementById("metadataModal");
        const tableBody = document.querySelector("#metadataTable tbody");
        const stack = larvitar.getLarvitarManager();
        const seriesId = larvitar.store.get([
          "viewports",
          "viewer",
          "seriesUID"
        ]);
        const sliceId = larvitar.store.get(["viewports", "viewer", "sliceId"]);
        const imageId = stack[seriesId].imageIds[sliceId];
        const instanceUid =
          stack[seriesId].instances[imageId].metadata.instanceUID;
        const metadata = larvitar.getImageMetadata(
          seriesId,
          instanceUid,
          sliceId
        );
        localStorage.setItem("tableData", JSON.stringify(metadata));
        window.open("metadataTable.html", "_blank");
      }

      function renderSerie() {
        larvitar.resetLarvitarManager();
        larvitar
          .readFiles(demoFiles)
          .then(seriesStack => {
            // render the first series of the study
            let seriesId = _.keys(seriesStack)[0];
            larvitar.populateLarvitarManager(seriesId, seriesStack[seriesId]);
            let manager = larvitar.getLarvitarManager();
            let serie = manager[seriesId];
            larvitar.renderImage(serie, "viewer").then(() => {
              console.log("Image has been rendered");
              hideSpinner(); // Hide the spinner when all files are processed
              larvitar.resetViewports(["viewer"]);
            });
            // optionally cache the series

            _.each(_.keys(seriesStack), function (seriesId) {
              larvitar.populateLarvitarManager(seriesId, seriesStack[seriesId]);
              larvitar.cacheImages(seriesStack[seriesId], function (resp) {
                if (resp.loading == 100) {
                  let cache = larvitar.cornerstone.imageCache;
                  console.log(
                    "Cache size: ",
                    cache.getCacheInfo().cacheSizeInBytes / 1e6,
                    "Mb"
                  );
                }
              });
            });

            series = serie;
            const keys = Object.keys(
              serie.instances[serie.imageIds[0]].metadata
            ).filter(item => item.startsWith("x"));
            for (key in keys) {
              if (
                typeof serie.instances[serie.imageIds[0]].metadata[
                  keys[key]
                ] === "string"
              ) {
                let newElement = document.createElement("label");
                newElement.innerHTML = keys[key];
                let newChild = document.createElement("input");
                newChild.id = keys[key];
                newChild.placeholder =
                  serie.instances[serie.imageIds[0]].metadata[keys[key]];
                document.getElementById("metadata").appendChild(newElement);
                newElement.appendChild(newChild);
              }
            }
            larvitar.addDefaultTools();
          })
          .catch(err => console.error(err));
      }

      let demoFileList = getDemoFileNames();
      showSpinner(); // Show the spinner
      _.each(demoFileList, function (demoFile) {
        createFile(demoFile, renderSerie);
      });

      function previousImage() {
        const stack = larvitar.getLarvitarManager();
        const seriesIds = Object.keys(stack);
        const seriesId = larvitar.store.get([
          "viewports",
          "viewer",
          "seriesUID"
        ]);
        const index = seriesIds.indexOf(seriesId);
        if (index > 0) {
          showSpinner();
          const newSeriesId = seriesIds[index - 1];
          const serie = stack[newSeriesId];
          larvitar.renderImage(serie, "viewer").then(() => {
            console.log("Image has been rendered");
            hideSpinner(); // Hide the spinner when all files are processed
            larvitar.resetViewports(["viewer"]);
          });
        }
      }

      function nextImage() {
        const stack = larvitar.getLarvitarManager();
        const seriesIds = Object.keys(stack);
        const seriesId = larvitar.store.get([
          "viewports",
          "viewer",
          "seriesUID"
        ]);
        const index = seriesIds.indexOf(seriesId);
        if (index < seriesIds.length - 1) {
          showSpinner();
          const newSeriesId = seriesIds[index + 1];
          const serie = stack[newSeriesId];
          larvitar.renderImage(serie, "viewer").then(() => {
            console.log("Image has been rendered");
            hideSpinner(); // Hide the spinner when all files are processed
            larvitar.resetViewports(["viewer"]);
          });
        }
      }

      // Event listener for arrow keys
      document.addEventListener("keydown", event => {
        if (event.key === "ArrowLeft") {
          previousImage();
        } else if (event.key === "ArrowRight") {
          nextImage();
        }
      });
    </script>
  </body>
</html>
