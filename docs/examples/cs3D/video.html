<!doctype html>
<html class="h-100 overflow-hidden">
  <head>
    <meta charset="UTF-8" />

    <!-- Include the Larvitar script -->
    <script>
      // Check the host and set the script source dynamically
      const script = document.createElement("script");
      if (window.location.host === "larvitar.dvisionlab.com") {
        document.write(
          '<script src="https://larvitar.dvisionlab.com/assets/larvitar.js"><\/script>'
        );
      } else {
        document.write('<script src="../../../dist/larvitar.js"><\/script>');
      }
      // Append the script to the document
      document.head.appendChild(script);
    </script>

    <!-- Add the Bootstrap CSS and Prism CSS for code modal -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"
    />

    <!-- Include the CSS file -->
    <link rel="stylesheet" href="../resources/styles.css" />

    <!-- custom styles for the example -->
    <style></style>

    <!-- Add the Bootstrap JS and Prism JS for code modal -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>

    <!-- Code to be displayed as source example code -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const showCodeBtn = document.getElementById("showCodeBtn");
        const codeSnippet = document.getElementById("codeSnippet");
        const copyCodeBtn = document.getElementById("copyCodeBtn");

        // TODO Code snippet to be displayed and updated for the example
        const code = ``;

        // Show the modal and populate code snippet
        showCodeBtn.addEventListener("click", () => {
          codeSnippet.textContent = code;
          Prism.highlightElement(codeSnippet); // Highlight the code
          const codeModal = new bootstrap.Modal(
            document.getElementById("codeModal")
          );
          codeModal.show();
        });

        // Copy the code to clipboard
        copyCodeBtn.addEventListener("click", () => {
          navigator.clipboard.writeText(code);
        });
      });
    </script>

    <title>Larvitar CS3D - Video rendering example</title>
  </head>

  <body class="h-100" style="background-color: #000000">
    <div class="row h-100">
      <div id="viewer" class="col-12 h-100" style="background-color: black">
        <button
          id="showCodeBtn"
          class="open-button"
          style="position: absolute; top: 10px"
        >
          Show Code
        </button>

        <!-- Modal -->
        <div
          class="modal fade"
          id="codeModal"
          tabindex="-1"
          aria-labelledby="codeModalLabel"
          aria-hidden="true"
        >
          <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="codeModalLabel">JavaScript Code</h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
              <div class="modal-body">
                <pre><code id="codeSnippet" class="language-javascript"></code></pre>
              </div>
              <div class="modal-footer">
                <button id="copyCodeBtn" class="btn btn-success">
                  Copy Code
                </button>
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Close
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Spinner icon -->
        <div id="spinner"></div>
      </div>
    </div>

    <script>
      const spinner = document.getElementById("spinner");

      // Show spinner
      function showSpinner() {
        spinner.style.display = "block";
      }

      // Hide spinner
      function hideSpinner() {
        spinner.style.display = "none";
      }

      let demoFiles = [];
      let series;

      // init all
      larvitar._cornerstone.init();
      larvitar._initializeCSTools();
      larvitar._initializeImageLoader();
      // initialize store and add viewport
      larvitar.store.initialize();
      larvitar.store.addViewport("viewer");

      //showSpinner();

      async function createFile(fileName, cb) {
        let response = await fetch("../demo/" + fileName);
        let data = await response.blob();
        let file = new File([data], fileName);
        demoFiles.push(file);
        cb();
        // const url =
        //   "http://192.168.72.141:80/dicomwebcore/wado/studies/1.2.826.0.1.3680043.2.619.9.1.30.850670163.21181/series/1.2.40.0.13.53.55.0.2.25.122365416602926697921596220541294743528/instances/2.25.28570818127938426128093968801678168183";
        // let response = await fetch(url, {
        //   method: "GET",
        //   headers: {
        //     Accept: "application/dicom"
        //   }
        // });
        // let data = await response.arrayBuffer();
        // let file = new File([data], fileName);
        // console.log("File created:", file);
        // demoFiles.push(file);

        // cb();
      }

      async function renderSerie() {
        larvitar
          .readFiles(demoFiles)
          .then(async seriesStack => {
            console.log("Series stack:", seriesStack);
            //populate the image manager with the series
            for (const [uniqueId, data] of Object.entries(seriesStack)) {
              larvitar.populateImageManager(uniqueId, data);
            }
            // render the first series of the study
            let uniqueUID = Object.keys(seriesStack)[0];
            let manager = larvitar.getImageManager();
            let serie = manager[uniqueUID];

            console.log("Serie:", serie);

            const dataset = serie.instances["dicomfile:0"].dataSet;
            console.log("Dataset:", dataset);

            const pixelElement = dataset.elements.x7fe00010;
            if (!pixelElement) {
              console.error("❌ Pixel Data non trovato");
              return;
            }
            const { dataOffset, length } = pixelElement;

            const transferSyntax = dataset.string("x00020010");
            console.log("Transfer Syntax:", transferSyntax);

            if (pixelElement.fragments?.length) {
              // Unisci tutti i frammenti in un singolo Uint8Array
              const fragmentBuffers = pixelElement.fragments.map(fragment => {
                return dataset.byteArray.slice(
                  fragment.position,
                  fragment.position + fragment.length
                );
              });

              // Calcola la lunghezza totale
              const totalLength = fragmentBuffers.reduce(
                (sum, frag) => sum + frag.length,
                0
              );

              // Crea un unico buffer
              var fullBuffer = new Uint8Array(totalLength);
              let offset = 0;
              for (const frag of fragmentBuffers) {
                fullBuffer.set(frag, offset);
                offset += frag.length;
              }
            } else {
              // Se non ci sono frammenti, usa il byte array direttamente
              var fullBuffer = dataset.byteArray.slice(
                dataOffset,
                dataOffset + length
              );
            }

            // Crea il blob con MIME corretto (MPEG2)
            const blob = new Blob([fullBuffer], { type: "video/mp4" });

            function downloadBlob(blob, filename) {
              const url = URL.createObjectURL(blob);

              const a = document.createElement("a");
              a.href = url;
              a.download = filename;
              a.style.display = "none";

              document.body.appendChild(a);
              a.click();

              URL.revokeObjectURL(url);
              document.body.removeChild(a);
            }

            const videoUrl = URL.createObjectURL(blob);
            console.log("Video URL:", videoUrl);

            // downloadBlob(blob, "extracted-video.mp4");
            const renderingEngine = larvitar._initializeRenderingEngine("1234");
            const viewportInput = {
              viewportId: "viewer",
              type: larvitar._cornerstone.Enums.ViewportType.VIDEO,
              element: document.getElementById("viewer"),
              defaultOptions: {
                background: [0.2, 0, 0.2]
              }
            };
            renderingEngine.enableElement(viewportInput);
            const viewport = renderingEngine.getViewport("viewer");
            console.log("Viewport:", viewport);

            const imageId = serie.imageIds[0];
            const firstInstance = serie.instances[serie.imageIds[0]];
            const metadata = firstInstance.metadata;

            larvitar._addCompleteVideoMetadata({
              imageId,
              videoUrl,
              metadata
            });
            /*
            console.log(
              "imageUrlModule:",
              larvitar._cornerstone.metaData.get("imageUrlModule", imageId)
            );
            console.log(
              "generalSeriesModule:",
              larvitar._cornerstone.metaData.get("generalSeriesModule", imageId)
            );
            console.log(
              "cineModule:",
              larvitar._cornerstone.metaData.get("cineModule", imageId)
            );
            console.log(
              "imagePlaneModule:",
              larvitar._cornerstone.metaData.get("imagePlaneModule", imageId)
            );*/

            //await viewport.setVideoURL(videoUrl);
            await viewport.setVideo(imageId);

            setTimeout(() => {
              viewport.play();
            }, 100);
          })
          .catch(err => console.error(err));
      }

      createFile("dicom_mpeg4.dcm", renderSerie);
    </script>
  </body>
</html>
