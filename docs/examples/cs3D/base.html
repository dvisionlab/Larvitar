<!DOCTYPE html>
<html class="h-100 overflow-hidden">

<head>
  <meta charset="UTF-8" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/vs2015.min.css" />
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js"></script>
  <script>
    hljs.highlightAll();
  </script>
  <title>Larvitar CS3D - Basic rendering example</title>
</head>

<body class="h-100" style="background-color: #000000">
  <div class="row h-100">
    <div id="viewer" class="col-8 h-100" style="background-color: black"></div>

    <div class="col-4 h-100">
      <pre class="h-100">
          <code class="javascript" style="background-color: #000000">
          <p style="font-size:0.6vw;"> 
          </p>
          </code>
        </pre>
    </div>
  </div>

  <script src="../../../dist/larvitar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>

  <script>
    let demoFiles = [];
    let counter = 0;
    let series;

    const getDemoFileNames = function () {
      let demoFileList = [];
      for (let i = 1; i < 25; i++) {
        let filename = "anon" + i;
        demoFileList.push(filename);
      }
      return demoFileList;
    };

    // init all
    larvitar._cornerstone.init();
    larvitar._initializeImageLoader();
    larvitar.store.initialize();
    larvitar.store.addViewport("viewer");

    async function createFile(fileName, cb) {
      let response = await fetch("../demo/" + fileName);
      let data = await response.blob();
      let file = new File([data], fileName);
      demoFiles.push(file);
      counter++;
      if (counter == 24) {
        cb();
      }
    }

    async function renderSerie() {
      larvitar
        ._readFiles(demoFiles)
        .then(async seriesStack => {
          const seriesId = _.keys(seriesStack)[0];
          const serie = seriesStack[seriesId];
          larvitar._renderImage(serie, "viewer").then(async ({ success, renderingEngine }) => {
            console.log("Image has been rendered");
            window.renderingEngine = renderingEngine;

            // cs tools stuff 

            const element = renderingEngine.getViewport("viewer").element;
            element.oncontextmenu = (e) => e.preventDefault();

            const { _cornerstoneTools } = larvitar;
            await _cornerstoneTools.init();

            const viewport = renderingEngine.getViewport('viewer');
            _cornerstoneTools.utilities.stackPrefetch.enable(viewport.element);

            const {
              PanTool,
              WindowLevelTool,
              StackScrollMouseWheelTool,
              ZoomTool,
              ToolGroupManager,
              Enums: csToolsEnums,
            } = _cornerstoneTools;

            const { MouseBindings } = csToolsEnums;

            _cornerstoneTools.addTool(WindowLevelTool);
            // _cornerstoneTools.addTool(PanTool);
            // _cornerstoneTools.addTool(StackScrollMouseWheelTool);
            // _cornerstoneTools.addTool(ZoomTool);

            const toolGroupId = 'GROUP_ID';
            const toolGroup = ToolGroupManager.createToolGroup(toolGroupId);
            window.toolGroup = toolGroup;

            toolGroup.addViewport("viewer", "2d");

            // Add tools to the tool group
            toolGroup.addTool(WindowLevelTool.toolName);
            // toolGroup.addTool(PanTool.toolName);
            // toolGroup.addTool(ZoomTool.toolName);
            // toolGroup.addTool(StackScrollMouseWheelTool.toolName, { loop: false });

            toolGroup.setToolActive(WindowLevelTool.toolName, {
              bindings: [
                {
                  mouseButton: MouseBindings.Primary, // Left Click
                },
              ],
            });

            /*
            toolGroup.setToolActive(PanTool.toolName, {
              bindings: [
                {
                  mouseButton: MouseBindings.Auxiliary, // Middle Click
                },
              ],
            });

            toolGroup.setToolActive(ZoomTool.toolName, {
              bindings: [
                {
                  mouseButton: MouseBindings.Secondary, // Right Click
                },
              ],
            });

            toolGroup.setToolActive(StackScrollMouseWheelTool.toolName);
            */

            renderingEngine.renderViewport("viewer");

          });
        })
        .catch(err => console.error(err));
    }

    let demoFileList = getDemoFileNames();
    _.each(demoFileList, function (demoFile) {
      createFile(demoFile, renderSerie);
    });
  </script>
</body>

</html>