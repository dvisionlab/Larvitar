<!DOCTYPE html>
<html class="h-100 overflow-hidden">
  <head>
    <meta charset="UTF-8" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/vs2015.min.css"
    />
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js"></script>
    <script>
      hljs.highlightAll();
    </script>
    <title>Larvitar CS3D - Basic Volume rendering example</title>
  </head>

  <body class="h-100" style="background-color: #000000">
    <div class="row h-100">
      <div
        id="viewer-1"
        class="col-4 h-100"
        style="background-color: black"
      ></div>
      <div
        id="viewer-2"
        class="col-4 h-100"
        style="background-color: black"
      ></div>

      <div class="col-4 h-100">
        <pre class="h-100">
          <code class="javascript" style="background-color: #000000">
          <p style="font-size:0.6vw;"> 
          </p>
          </code>
        </pre>
      </div>
    </div>

    <script src="../../../dist/larvitar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>

    <script>
      let demoFiles = [];
      let counter = 0;
      let series;

      const getDemoFileNames = function () {
        let demoFileList = [];
        for (let i = 1; i < 6; i++) {
          let filename = "anon" + i;
          demoFileList.push(filename);
        }
        return demoFileList;
      };

      // init all
      larvitar._cornerstone.init();
      larvitar._initializeImageLoader();
      larvitar._registerStreamingImageVolume();
      // larvitar.initializeCSTools();
      larvitar.store.initialize();
      larvitar.store.addViewport("viewer-1");
      larvitar.store.addViewport("viewer-2");

      async function createFile(fileName, cb) {
        let response = await fetch("../demo/3d/" + fileName);
        let data = await response.blob();
        let file = new File([data], fileName);
        demoFiles.push(file);
        counter++;
        if (counter == 5) {
          cb();
        }
      }

      async function renderSerie() {
        larvitar
          ._readFiles(demoFiles) // need to port the updateLoadedStack function
          .then(async seriesStack => {
            const seriesId = _.keys(seriesStack)[0];
            const serie = seriesStack[seriesId];
            const imageIds = serie.imageIds;

            console.log(serie);

            const element1 = document.getElementById("viewer-1");
            const element2 = document.getElementById("viewer-2");

            const renderingEngineId = "myRenderingEngine";
            const renderingEngine = new larvitar._cornerstone.RenderingEngine(
              renderingEngineId
            );

            const volumeId = "cornerstoneStreamingImageVolume: myVolume";

            imageIds.forEach(imageId => {
              const metadata = larvitar._convertMetadata(
                serie.instances[imageId].dataSet
              );
              larvitar._cornerstoneDICOMImageLoader.wadors.metaDataManager.add(
                imageId,
                metadata
              );
            });

            await larvitar._loadAndCacheMetadata(imageIds);

            const volume =
              await larvitar._cornerstone.volumeLoader.createAndCacheVolume(
                volumeId,
                { imageIds: imageIds.map(id => id) }
              );

            const viewportId1 = "CT_AXIAL";
            const viewportId2 = "CT_SAGITTAL";
            const viewportInput = [
              {
                viewportId: viewportId1,
                element: element1,
                type: "orthographic",
                defaultOptions: {
                  orientation: "axial"
                }
              },
              {
                viewportId: viewportId2,
                element: element2,
                type: "orthographic",
                defaultOptions: {
                  orientation: "sagittal"
                }
              }
            ];

            renderingEngine.setViewports(viewportInput);
            await volume.load();
            console.log(volume);
            console.log("volume loaded");
            larvitar._cornerstone.setVolumesForViewports(
              renderingEngine,
              [
                {
                  volumeId,
                  callback: ({ volumeActor }) => {
                    console.log("volumeActor", volumeActor);
                  }
                }
              ],
              [viewportId1, viewportId2]
            );

            // Render the image
            // renderingEngine.enableElement(viewportInput);
            // renderingEngine.render();
            await renderingEngine.renderViewports([viewportId1, viewportId2]);

            console.log("renderingEngine", renderingEngine);
          })
          .catch(err => console.error(err));
      }

      let demoFileList = getDemoFileNames();
      _.each(demoFileList, function (demoFile) {
        createFile(demoFile, renderSerie);
      });
    </script>
  </body>
</html>
