<!DOCTYPE html>
<html class="h-100 overflow-hidden">
  <head>
    <meta charset="UTF-8" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/vs2015.min.css"
    />
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js"></script>
    <script>
      hljs.highlightAll();
    </script>
    <title>Larvitar - Basic rendering example</title>
  </head>

  <body class="h-100" style="background-color: #000000">
    <div class="row h-100">
      <div class="col-5 h-100">
        <div id="viewer" class="h-100"></div>
      </div>
      <div class="col-5 h-100">
        <div id="imageResult" class="h-100"></div>
      </div>

      <div class="col-2">
        <button id="DSA" class="btn btn-primary" onclick="ChangeLayer()">
          Change Layer
        </button>
      </div>
    </div>

    <script src="../../dist/larvitar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script src="https://unpkg.com/dicom-parser/dist/dicomParser.js"></script>
    <script src="./DSA_onstack.js"></script>
    <script>
      let demoFiles = [];

      // init all
      larvitar.initializeImageLoader();
      larvitar.registerMultiFrameImageLoader();
      larvitar.initializeCSTools();
      larvitar.store.initialize();
      larvitar.store.addViewport("viewer");

      let layer_1; //, layer_2;
      //const cacheImagesAsync = promisify(larvitar.cacheImages.bind(larvitar));
      function ChangeLayer() {
        let oldactiveLayer = larvitar.getActiveLayer("viewer");
        console.log(layer_1);
        larvitar.updateLayer("viewer", layer_1.id, { opacity: 1 });
        console.log(layer_1);
        let newopacity =
          oldactiveLayer.layerId == layer_1.id ? layer_2 : layer_1;
        //set slice of active layer to be the same of the slice of the previous active layer
        larvitar.setActiveLayer("viewer", newActiveLayer.id);
        larvitar.updateLayer("viewer", newActiveLayer.id, { opacity: 1 });
      }

      function renderSerie() {
        larvitar
          .readFiles(demoFiles)
          .then(seriesStack => {
            let seriesId = _.keys(seriesStack)[0];
            console.log(seriesStack);
            let serie = seriesStack[seriesId];
            larvitar.populateLarvitarManager(seriesId, serie);
            let manager = larvitar.getLarvitarManager();
            let multiFrameSerie = manager[seriesId];
            console.log(multiFrameSerie);
            let frameId = 0;

            let serie_1 = multiFrameSerie;

            layer_1 = larvitar.buildLayer(serie_1, "main", {
              opacity: 1,
              colormap: ""
            });

            // define a layer into the series object to be rendered
            serie_1.layer = layer_1;

            larvitar
              .renderImage(serie_1, "viewer", frameId)
              .then(() => {
                console.log("Image 1 has been rendered");
                return new Promise((resolve, reject) => {
                  larvitar.cacheImages(serie_1, resp => {
                    if (resp.loading === 100) {
                      resolve();
                    }
                  });
                });
              })
              .then(() => {
                let multiFrameSerie2 = _.cloneDeep(multiFrameSerie);
                multiFrameSerie2.instances = _.cloneDeep({});
                multiFrameSerie2.instanceUIDs = _.cloneDeep({});
                console.log(multiFrameSerie2.imageIds.length);
                return applyDSA(
                  multiFrameSerie2,
                  multiFrameSerie,
                  manager
                ).then(serie_2 => {
                  manager[multiFrameSerie2.seriesUID] = serie_2;
                  layer_2 = larvitar.buildLayer(serie_2, "colored", {
                    opacity: 0.25,
                    colormap: ""
                  });
                  serie_2.layer = layer_2;
                  let element = document.getElementById("viewer");
                  let imageTracker = larvitar.getLarvitarImageTracker();
                  imageTracker["multiFrameLoader://1"] =
                    multiFrameSerie2.seriesUID;
                  console.log(imageTracker);
                  console.log(manager);
                  let visibleLayers =
                    larvitar.cornerstone.getVisibleLayers(element);

                  frameId = 0;

                  console.log("SERIE 1", serie_1);
                  console.log("SERIE 2", serie_2);
                  larvitar.renderImage(serie_2, "viewer", frameId).then(() => {
                    larvitar.addDefaultTools("viewer");
                    console.log("Image 2 has been rendered");
                  });
                });
              });
          })

          .catch(err => console.log(err));
      }

      async function applyDSA(multiFrameSerie2, multiFrameSerie, manager) {
        const imageIds = multiFrameSerie2.imageIds;
        const promises = [];
        multiFrameSerie2.images = {};
        for (let i = 0; i < imageIds.length; i++) {
          const frameId = imageIds[i];
          let instance =
            multiFrameSerie.instances[multiFrameSerie2.imageIds[i]];
          console.log(instance);
          promises.push(
            apply_DSA_Mask(multiFrameSerie2, frameId, instance, i).then(
              ([resultFrame, resultinstance]) => {
                multiFrameSerie2.imageIds[i] = resultFrame.imageId;

                multiFrameSerie2.instances[multiFrameSerie2.imageIds[i]] = {
                  ...resultinstance
                };

                multiFrameSerie2.images[multiFrameSerie2.imageIds[i]] =
                  resultFrame;
              }
            )
          );
        }

        return Promise.all(promises).then(() => {
          delete multiFrameSerie2.layer;
          multiFrameSerie2.seriesUID = multiFrameSerie2.seriesUID + "-DSA";
          multiFrameSerie2.studyUID = multiFrameSerie2.studyUID + "-DSA";
          let instanceUIDs = multiFrameSerie2.seriesUID;

          multiFrameSerie2.instanceUIDs[instanceUIDs] = "multiFrameLoader://1";
          console.log(instanceUIDs);
          multiFrameSerie2.larvitarSeriesInstanceUID =
            multiFrameSerie2.larvitarSeriesInstanceUID + "-DSA";
          //TODO same with instanceUID
          return multiFrameSerie2;
        });
      }

      async function createFile(fileName, cb) {
        let response = await fetch("./demo/DSA/" + fileName);
        let data = await response.blob();
        let file = new File([data], fileName);
        demoFiles.push(file);
        cb();
      }
      createFile("XA-DSA-Shutter.dcm", renderSerie);
    </script>
  </body>
</html>
