<!DOCTYPE html>
<html class="h-100 overflow-hidden">
  <head>
    <meta charset="UTF-8" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/vs2015.min.css"
    />
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js"></script>
    <script>
      hljs.highlightAll();
    </script>
    <title>Larvitar - Basic rendering example</title>
  </head>

  <body class="h-100" style="background-color: #000000">
    <div class="row h-100">
      <div class="col-10 h-100">
        <div id="viewer" class="h-100"></div>
      </div>
    </div>

    <script src="./larvitar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script>
      let demoFiles = [];

      // init all
      larvitar.initializeImageLoader();
      larvitar.registerMultiFrameImageLoader();
      larvitar.registerDsaImageLoader();
      larvitar.initializeCSTools();
      larvitar.store.initialize();
      larvitar.store.addViewport("viewer");

      async function renderSerie() {
        const seriesStack = await larvitar.readFiles(demoFiles);
        // render the first series of the study
        let seriesId = _.keys(seriesStack)[0];
        let serie = seriesStack[seriesId];
        larvitar.populateLarvitarManager(seriesId, serie);
        let manager = larvitar.getLarvitarManager();
        let multiFrameSerie = manager[seriesId];

        let frameId = 0;
        await larvitar.renderImage(multiFrameSerie, "viewer", frameId);
        console.log("Image has been rendered");

        larvitar.addDefaultTools();
        larvitar.setToolActive("Wwwc");
        await larvitar.loadAndCacheImageStack(multiFrameSerie);

        document.onkeypress = function (e) {
          e = e || window.event;
          switch (e.keyCode) {
            case 49:
              larvitar.store.setDSAEnabled(["viewer"], false);
              larvitar.updateImage(multiFrameSerie, "viewer", frameId);
              break;
            case 50:
              larvitar.store.setDSAEnabled(["viewer"], true);
              larvitar.updateImage(multiFrameSerie, "viewer", frameId);
              break;
            case 51:
              setInterval(function () {
                frameId =
                  frameId == multiFrameSerie.numberOfFrames - 1
                    ? 0
                    : frameId + 1;
                larvitar.updateImage(multiFrameSerie, "viewer", frameId, false);
              }, multiFrameSerie.frameTime);
              break;
          }
        };

        setTimeout(function () {
          // TODO FIX WHEEL EVENT
          // TODO FIX WW/WL ON CANVAS WHEN SWITCHING FROM DSA TO NON DSA
          larvitar.updateImage(multiFrameSerie, "viewer", frameId);
        }, 1000);
      }

      async function createFile(fileName, cb) {
        let response = await fetch("./demo/DSA/" + fileName);
        let data = await response.blob();
        let file = new File([data], fileName);
        demoFiles.push(file);
        cb();
      }

      createFile("XA-DSA-Shutter.dcm", renderSerie);

      /* so che una serie dicom a cui applicare la dsa
      vado buildare il manager con la serie multiframe originale
      cacho tutti i multiframe 
      e poi cacho tutti i multiframe con la dsa con degli imageID diversi
      questi imageID devo costruirli in qualche modo evitando di duplicare oggetti
    


      avere una funzione che prende in input una lista di custom imageIDS
      per poterli cachare tutti insieme
      costruire quindi un custom loader

      */
    </script>
  </body>
</html>
