<!DOCTYPE html>
<html class="h-100 overflow-hidden">
  <head>
    <meta charset="UTF-8" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/vs2015.min.css"
    />
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js"></script>
    <script>
      hljs.highlightAll();
    </script>
    <title>Larvitar - Basic rendering example</title>
  </head>

  <body class="h-100" style="background-color: #000000">
    <div class="row h-100">
      <div
        id="viewer"
        class="col-8 h-100"
        style="background-color: black"
      ></div>

      <div class="col-4 h-100">
        <pre class="h-100">
          <code class="javascript" style="background-color: #000000">
          <p style="font-size:0.6vw;">
            let demoFiles = [];
            let counter = 0;

            const getDemoFileNames = function () {
              let demoFileList = [];
              for (let i = 1; i < 25; i++) {
                let filename = "anon" + i;
                demoFileList.push(filename);
              }
              return demoFileList;
            };

            // init all
            larvitar.initializeImageLoader();
            larvitar.initializeCSTools();
            larvitar.store.initialize();
            larvitar.store.addViewport("viewer");

            async function createFile(fileName, cb) {
              let response = await fetch("./demo/" + fileName);
              let data = await response.blob();
              let file = new File([data], fileName);
              demoFiles.push(file);
              counter++;
              if (counter == 24) {
                cb();
              }
            }

            function renderSerie() {
              larvitar.resetLarvitarManager();
              larvitar
                .readFiles(demoFiles)
                .then(seriesStack => {
                  // render the first series of the study
                  let seriesId = _.keys(seriesStack)[0];
                  let serie = seriesStack[seriesId];
                  larvitar.renderImage(serie, "viewer").then(() => {
                    console.log("Image has been rendered");
                  });
                  // optionally cache the series
                  larvitar.populateLarvitarManager(seriesId, serie);
                  larvitar.cacheImages(serie, function (resp) {
                    if (resp.loading == 100) {
                      let cache = larvitar.cornerstone.imageCache;
                      console.log(
                        "Cache size: ",
                        cache.getCacheInfo().cacheSizeInBytes / 1e6,
                        "Mb"
                      );
                    }
                  });
                  larvitar.addDefaultTools();
                  larvitar.setToolActive("Wwwc");
                })
                .catch(err => console.log(err));
            }

            let demoFileList = getDemoFileNames();
            _.each(demoFileList, function (demoFile) {
              createFile(demoFile, renderSerie);
            });
          </p>
          </code>
        </pre>
      </div>
    </div>

    <script src="./larvitar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>

    <script>
      let demoFiles = [];
      let counter = 0;
      let dataset1;
      larvitar.initializeImageLoader();
      larvitar.initializeCSTools();
      larvitar.store.initialize();
      larvitar.store.addViewport("viewer");
      const getDemoFileNames = function () {
        let demoFileList = [];
        for (let i = 1; i < 2; i++) {
          let filename = "modified_testlungo3.dcm";
          demoFileList.push(filename);
        }
        return demoFileList;
      };

      async function createFile(fileName, cb) {
        let response = await fetch(fileName);
        let data = await response.blob();
        let file = new File([data], fileName);
        demoFiles.push(file);
        counter++;
        if (counter == 1) {
          cb();
        }
      }

      function renderSerie() {
        larvitar.resetLarvitarManager();
        larvitar
          .readFiles(demoFiles)
          .then(seriesStack => {
            let seriesId = _.keys(seriesStack)[0];
            let serie = seriesStack[seriesId];
            larvitar.renderImage(serie, "viewer").then(() => {
              console.log("Image has been rendered");
            });
            larvitar.populateLarvitarManager(seriesId, serie);
            larvitar.cacheImages(serie, function (resp) {
              if (resp.loading == 100) {
                let cache = larvitar.cornerstone.imageCache;
                console.log(
                  "Cache size: ",
                  cache.getCacheInfo().cacheSizeInBytes / 1e6,
                  "Mb"
                );
              }
            });
            const imageId = serie.imageIds[0];
            let image = serie.instances[imageId];

            console.log(image.dataSet.byteArray);
            var blob = new Blob([image.dataSet.byteArray], {
              type: "application/dicom"
            });
            var url = window.URL.createObjectURL(blob);
            window.open(url);
            window.URL.revokeObjectURL(url);
            larvitar.addDefaultTools();
            larvitar.setToolActive("Wwwc");
            console.log(serie);
            console.log("BEFORE", image.dataSet);
            dataset1 = image.dataSet.byteArray;
            console.log("dataset1", dataset1);
          })
          .catch(err => console.error(err));
      }

      let demoFileList = getDemoFileNames();
      _.each(demoFileList, function (demoFile) {
        createFile(demoFile, renderSerie);
      });

      // Now for the second set of files

      let demoFiles2 = []; // New array for the second set of demo files
      let counter2 = 0;
      let dataset2;

      const getDemoFileNames2 = function () {
        let demoFileList2 = [];
        for (let i = 1; i < 2; i++) {
          let filename2 = "testlungo.dcm";
          demoFileList2.push(filename2);
        }
        return demoFileList2;
      };

      async function createFile2(fileName, cb) {
        // Renamed function
        let response = await fetch(fileName);
        let data = await response.blob();
        let file = new File([data], fileName);
        demoFiles2.push(file); // Use demoFiles2 array
        counter2++;
        if (counter2 == 1) {
          cb();
        }
      }

      function renderSerie2() {
        larvitar.resetLarvitarManager();
        larvitar
          .readFiles(demoFiles2) // Use demoFiles2 array
          .then(async seriesStack => {
            let seriesId = _.keys(seriesStack)[0];
            let serie = seriesStack[seriesId];
            larvitar.renderImage(serie, "viewer").then(() => {
              console.log("Image has been rendered");
            });
            larvitar.populateLarvitarManager(seriesId, serie);
            larvitar.cacheImages(serie, function (resp) {
              if (resp.loading == 100) {
                let cache = larvitar.cornerstone.imageCache;
                console.log(
                  "Cache size: ",
                  cache.getCacheInfo().cacheSizeInBytes / 1e6,
                  "Mb"
                );
              }
            });
            larvitar.addDefaultTools();
            larvitar.setToolActive("Wwwc");
            const imageId = serie.imageIds[0];
            let image = serie.instances[imageId];

            await larvitar.customizeByteArray(serie, {
              x00100010:
                "pippobsckhabevfnjasnnjsmcnkadbcsjdvbdjvblsdjvbldjvbldvjbldvddlbvldjvba"
            });
            setTimeout(() => {
              console.log("AFTER", image.dataSet);
              console.log("series", serie);
              console.log(image.dataSet.byteArray);
              var blob = new Blob([image.dataSet.byteArray], {
                type: "application/dicom"
              });
              var url = window.URL.createObjectURL(blob);
              window.open(url);
              window.URL.revokeObjectURL(url);
              dataset2 = image.dataSet.byteArray;
              console.log("dataset2", dataset2);
              console.log(serie);
            }, 2000);
          })
          .catch(err => console.error(err));
      }

      let demoFileList2 = getDemoFileNames2();
      setTimeout(() => {
        _.each(demoFileList2, function (demoFile) {
          createFile2(demoFile, renderSerie2); // Use createFile2 for the second set of files
        });
      }, 2000);

      // Reactively update the UI
      // larvitar.store.watch(data => console.log(data));
      setTimeout(() => {
        if (dataset1.length !== dataset2.length) {
          console.log("Arrays have different lengths");
        } else {
          let isEqual = true;
          let indexBreak = null;
          console.log("equal lengths");
          for (let i = 0; i < dataset1.length; i++) {
            if (dataset1[i] !== dataset2[i]) {
              isEqual = false;
              indexBreak = i;
            }
          }

          if (isEqual) {
            console.log("Arrays are identical");
          } else {
            console.log("Arrays are different at index", indexBreak);
          }
        }
      }, 7000);
    </script>
  </body>
</html>
