<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.19" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>GspsTool Documentation | Larvitar Documentation</title><meta name="description" content="Documentation for the Larvitar library">
    <link rel="preload" href="/assets/style--l-zKV1s.css" as="style"><link rel="stylesheet" href="/assets/style--l-zKV1s.css">
    <link rel="modulepreload" href="/assets/app-BVwHBcsb.js"><link rel="modulepreload" href="/assets/gspsTool.html-DH6wcyC1.js">
    <link rel="prefetch" href="/assets/index.html-B13rGNqA.js" as="script"><link rel="prefetch" href="/assets/index.html-BVx78I5Q.js" as="script"><link rel="prefetch" href="/assets/initializing.html-DWxj0CD1.js" as="script"><link rel="prefetch" href="/assets/interacting.html-wliH5kXU.js" as="script"><link rel="prefetch" href="/assets/loading.html-DBpVGVTO.js" as="script"><link rel="prefetch" href="/assets/parsing.html-CizzM823.js" as="script"><link rel="prefetch" href="/assets/rendering.html-Cd7w-5xd.js" as="script"><link rel="prefetch" href="/assets/testing.html-CfkEvZGZ.js" as="script"><link rel="prefetch" href="/assets/examples.html-jbWaqg58.js" as="script"><link rel="prefetch" href="/assets/index.html-3AxcbvlR.js" as="script"><link rel="prefetch" href="/assets/installation.html-4Ht6ZK62.js" as="script"><link rel="prefetch" href="/assets/logger.html-Lt1zdCJ6.js" as="script"><link rel="prefetch" href="/assets/store.html-DtJ-2av-.js" as="script"><link rel="prefetch" href="/assets/dicomLoader.html-DmPujtur.js" as="script"><link rel="prefetch" href="/assets/dsaImageLoader.html-B_LsPTMF.js" as="script"><link rel="prefetch" href="/assets/fileLoader.html-BB3Yxy7p.js" as="script"><link rel="prefetch" href="/assets/loaders.html-DUi7Hrxl.js" as="script"><link rel="prefetch" href="/assets/multiframeLoader.html-oox3HsCj.js" as="script"><link rel="prefetch" href="/assets/nrrdLoader.html-BTMg4gxR.js" as="script"><link rel="prefetch" href="/assets/singleFrameLoader.html-CP5V9bZa.js" as="script"><link rel="prefetch" href="/assets/fileManager.html-3IEeRJCH.js" as="script"><link rel="prefetch" href="/assets/gspsManager.html-DRU5Y_YJ.js" as="script"><link rel="prefetch" href="/assets/imageManager.html-DquI0-Km.js" as="script"><link rel="prefetch" href="/assets/ecg.html-D4n8oEtQ.js" as="script"><link rel="prefetch" href="/assets/nrrd.html-CGma_SXm.js" as="script"><link rel="prefetch" href="/assets/pdf.html-CibWwVxp.js" as="script"><link rel="prefetch" href="/assets/applyKernel.html-DUgiqPtH.js" as="script"><link rel="prefetch" href="/assets/dsa.html-BzG-1qcS.js" as="script"><link rel="prefetch" href="/assets/cypress.html-DEDLT-Ed.js" as="script"><link rel="prefetch" href="/assets/default.html-Blo7MnsQ.js" as="script"><link rel="prefetch" href="/assets/dvTools.html-C3HmUXvw.js" as="script"><link rel="prefetch" href="/assets/initialization.html-C2FdW8qq.js" as="script"><link rel="prefetch" href="/assets/segmentation.html-Ch2Yaotc.js" as="script"><link rel="prefetch" href="/assets/tools.html-4CPuYwHJ.js" as="script"><link rel="prefetch" href="/assets/anonymization.html-KqF8skRv.js" as="script"><link rel="prefetch" href="/assets/customization.html-Cj2f8x_c.js" as="script"><link rel="prefetch" href="/assets/imageTags.html-B7f79cCY.js" as="script"><link rel="prefetch" href="/assets/imageUtils.html-52R6byIz.js" as="script"><link rel="prefetch" href="/assets/memory.html-lJCVXM4T.js" as="script"><link rel="prefetch" href="/assets/stressEchoProtocol.html-eysPEHlM.js" as="script"><link rel="prefetch" href="/assets/colorMaps.html-BWdTBAlR.js" as="script"><link rel="prefetch" href="/assets/ecg.html-DVggt7zr.js" as="script"><link rel="prefetch" href="/assets/layers.html-BXlkGom2.js" as="script"><link rel="prefetch" href="/assets/404.html-C7HgF_WA.js" as="script"><link rel="prefetch" href="/assets/SearchResult-CK6ALX8u.js" as="script"><link rel="prefetch" href="/assets/setupDevtools-7MC2TMWH-CqNpmYkr.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/"><!----><span class="vp-site-name" aria-hidden="true">Larvitar Documentation</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!---->Home<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/guide/" aria-label="Guide"><!---->Guide<!----></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/api/" aria-label="API"><!---->API<!----></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/dvisionlab/Larvitar" aria-label="GitHub" rel="noopener noreferrer" target="_blank"><!---->GitHub<!----></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!--[--><button type="button" class="slimsearch-button" aria-label="Search"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="slimsearch-placeholder">Search</div><div class="slimsearch-key-hints"><kbd class="slimsearch-key">Ctrl</kbd><kbd class="slimsearch-key">K</kbd></div></button><!--]--></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/" aria-label="Home"><!---->Home<!----></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/guide/" aria-label="Guide"><!---->Guide<!----></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/api/" aria-label="API"><!---->API<!----></a></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/dvisionlab/Larvitar" aria-label="GitHub" rel="noopener noreferrer" target="_blank"><!---->GitHub<!----></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading active">API <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/api/initializing.html" aria-label="Initializing"><!---->Initializing<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/api/parsing.html" aria-label="Parsing"><!---->Parsing<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/api/loading.html" aria-label="Loading"><!---->Loading<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/api/rendering.html" aria-label="Rendering"><!---->Rendering<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/api/interacting.html" aria-label="Interacting"><!---->Interacting<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/api/testing.html" aria-label="Testing"><!---->Testing<!----></a><!----></li><li><p tabindex="0" class="vp-sidebar-item active">Modules <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/logger.html" aria-label="Logger"><!---->Logger<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/store.html" aria-label="Store"><!---->Store<!----></a><!----></li><li><p tabindex="0" class="vp-sidebar-item">Managers <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/managers/imageManager.html" aria-label="Image Manager"><!---->Image Manager<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/managers/gspsManager.html" aria-label="GSPS Manager"><!---->GSPS Manager<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/managers/fileManager.html" aria-label="File Manager"><!---->File Manager<!----></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item">Parsers <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/parsers/pdf.html" aria-label="PDF Parser"><!---->PDF Parser<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/parsers/nrrd.html" aria-label="NRRD Parser"><!---->NRRD Parser<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/parsers/ecg.html" aria-label="ECG Parser"><!---->ECG Parser<!----></a><!----></li><!--]--></ul></li><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/loaders/loaders.html" aria-label="Loaders"><!---->Loaders<!----></a><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/loaders/dicomLoader.html" aria-label="DICOM Loader"><!---->DICOM Loader<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/loaders/multiframeLoader.html" aria-label="MultiFrame Loader"><!---->MultiFrame Loader<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/loaders/singleFrameLoader.html" aria-label="SingleFrame Loader"><!---->SingleFrame Loader<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/loaders/dsaImageLoader.html" aria-label="DSA Image Loader"><!---->DSA Image Loader<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/loaders/fileLoader.html" aria-label="File Loader"><!---->File Loader<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/loaders/nrrdLoader.html" aria-label="Nrrd Loader"><!---->Nrrd Loader<!----></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item">Interaction Tools <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/tools/initialization.html" aria-label="Initialize and manage Tools"><!---->Initialize and manage Tools<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/tools/default.html" aria-label="Default and Custom Tools"><!---->Default and Custom Tools<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/tools/segmentation.html" aria-label="Segmentation Tools"><!---->Segmentation Tools<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/tools/dvTools.html" aria-label="DvTools"><!---->DvTools<!----></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item">Utilities <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/utilities/anonymization.html" aria-label="DICOM Anonymization"><!---->DICOM Anonymization<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/utilities/customization.html" aria-label="DICOM Customization"><!---->DICOM Customization<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/utilities/imageTags.html" aria-label="Tags"><!---->Tags<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/utilities/imageUtils.html" aria-label="Utils"><!---->Utils<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/utilities/memory.html" aria-label="Memory"><!---->Memory<!----></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item">Post Processing <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/postProcessing/dsa.html" aria-label="DSA"><!---->DSA<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/postProcessing/applyKernel.html" aria-label="Image Filters"><!---->Image Filters<!----></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="vp-sidebar-item active">Visualizations <!----></p><ul style="" class="vp-sidebar-children"><!--[--><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/visualizations/layers.html" aria-label="Layers"><!---->Layers<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/visualizations/ecg.html" aria-label="ECG"><!---->ECG<!----></a><!----></li><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/visualizations/colorMaps.html" aria-label="Color Maps"><!---->Color Maps<!----></a><!----></li><li><a class="route-link route-link-active auto-link vp-sidebar-item active" href="/api/modules/visualizations/gspsTool.html" aria-label="Greyscale Presentation States"><!---->Greyscale Presentation States<!----></a><!----></li><!--]--></ul></li><li><a class="route-link auto-link vp-sidebar-item" href="/api/modules/tests/cypress.html" aria-label="Testing"><!---->Testing<!----></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div class="theme-default-content" vp-content><!--[--><!--]--><div><div style="text-align:center;"><img src="https://assets.pokemon.com/assets/cms2/img/pokedex/full/246.png" alt="Larvitar" height="200"></div><h1 id="gspstool-documentation" tabindex="-1"><a class="header-anchor" href="#gspstool-documentation"><span>GspsTool Documentation</span></a></h1><h2 id="overview" tabindex="-1"><a class="header-anchor" href="#overview"><span>Overview</span></a></h2><p>The <code>GspsTool</code> class is a visualization tool for rendering presentation states over displayed medical images in a DICOM viewer. It extends <code>BaseTool</code> from <code>cornerstone-tools</code> and integrates various utilities for applying masks, transformations, LUTs, and annotations.</p><h2 id="imports" tabindex="-1"><a class="header-anchor" href="#imports"><span>Imports</span></a></h2><p>The tool imports several utility functions from <code>gspsUtils</code>:</p><ul><li><strong>Masking:</strong> <code>retrieveDisplayShutter</code>, <code>applyMask</code></li><li><strong>LUT Processing:</strong> <code>applyModalityLUT</code>, <code>applySoftcopyLUT</code>, <code>applySoftcopyPresentationLUT</code></li><li><strong>Spatial Transformations:</strong> <code>applySpatialTransformation</code>, <code>applyZoomPan</code></li><li><strong>Annotations &amp; Overlays:</strong> <code>retrieveAnnotationsToolData</code>, <code>retrieveOverlayToolData</code>, <code>renderOverlay</code>, <code>renderGraphicAnnotation</code>, <code>renderCompoundAnnotation</code>, <code>renderTextAnnotation</code></li></ul><p>Additionally, it imports:</p><ul><li><code>cornerstone-core</code> for image rendering and viewport manipulation</li><li><code>cornerstone-tools</code> for drawing utilities</li><li><code>cornerstone-wado-image-loader</code> for DICOM image loading</li><li>Image managers from <code>../../imageManagers</code></li><li>Rendering utilities from <code>../../imageRendering</code></li></ul><h2 id="class-gspstool" tabindex="-1"><a class="header-anchor" href="#class-gspstool"><span>Class: <code>GspsTool</code></span></a></h2><h3 id="properties" tabindex="-1"><a class="header-anchor" href="#properties"><span>Properties</span></a></h3><ul><li><code>name</code>: The tool name (default: &quot;Gsps&quot;)</li><li><code>configuration</code>: Tool configuration settings</li><li><code>toolAnnotations</code>: An array for storing annotation data</li><li><code>showAnnotations</code>: Boolean flag to toggle annotation visibility</li><li><code>canvas</code>: Reference to the drawing canvas</li><li><code>gspsMetadata</code>: Metadata related to the GSPS (Grayscale Softcopy Presentation State)</li></ul><h3 id="constructor" tabindex="-1"><a class="header-anchor" href="#constructor"><span>Constructor</span></a></h3><p>Initializes the tool with default properties:</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> defaultProps <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    name<span class="token operator">:</span> <span class="token string">&quot;Gsps&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    supportedInteractionTypes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Mouse&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Touch&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    configuration<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> defaultProps<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>configuration <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span>configuration<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> defaultProps<span class="token punctuation">.</span>name<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="class-methods" tabindex="-1"><a class="header-anchor" href="#class-methods"><span>Class Methods</span></a></h3><h4 id="activepassivecallback" tabindex="-1"><a class="header-anchor" href="#activepassivecallback"><span><code>activePassiveCallback</code></span></a></h4><p>Performs key operations:</p><ul><li>Retrieves the active element and image metadata</li><li>Checks if there is an applicable registered GSPS in GSPSDict for the currently displayed instanceUID</li><li>Applies LUT transformations and masks</li><li>Retrieves and renders annotations and overlays</li></ul><h4 id="rendertooldata" tabindex="-1"><a class="header-anchor" href="#rendertooldata"><span><code>renderToolData</code></span></a></h4><p>Renders annotations and overlays by:</p><ul><li>Configuring the drawing context</li><li>Checking image validity</li><li>Drawing overlays, graphic annotations, text annotations, and compound annotations</li></ul><h4 id="resetviewporttodefault" tabindex="-1"><a class="header-anchor" href="#resetviewporttodefault"><span><code>resetViewportToDefault</code></span></a></h4><p>Resets the viewport to its default state when the tool is Disabled.</p><h4 id="handleelement" tabindex="-1"><a class="header-anchor" href="#handleelement"><span><code>handleElement</code></span></a></h4><p>Waits for the image to become available before proceeding.</p><h3 id="apply-annotations-on-image" tabindex="-1"><a class="header-anchor" href="#apply-annotations-on-image"><span>Apply Annotations on Image</span></a></h3><h4 id="retrieve-annotations-from-dicom-metadata" tabindex="-1"><a class="header-anchor" href="#retrieve-annotations-from-dicom-metadata"><span>Retrieve Annotations from DICOM Metadata</span></a></h4><h5 id="retrieveannotationstooldata" tabindex="-1"><a class="header-anchor" href="#retrieveannotationstooldata"><span><code>retrieveAnnotationsToolData</code></span></a></h5><p>Extracts annotation sequences (text and graphic objects) from DICOM metadata, organizes them for display, and handles rendering order.</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">function</span> <span class="token function">retrieveAnnotationsToolData</span><span class="token punctuation">(</span></span>
<span class="line">  metadata<span class="token operator">:</span> MetaData<span class="token punctuation">,</span></span>
<span class="line">  toolAnnotations<span class="token operator">:</span> ToolAnnotations<span class="token punctuation">,</span></span>
<span class="line">  graphicLayers<span class="token operator">?</span><span class="token operator">:</span> MetaData<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  graphicGroups<span class="token operator">?</span><span class="token operator">:</span> MetaData<span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Implementation Details</strong>:</p><ol><li>Retrieves the <strong>Graphic Annotation Sequence</strong> (<code>x00700001</code>).</li><li>Iterates through each annotation and extracts: <ul><li><strong>Annotation ID</strong> (<code>x00700002</code>).</li><li>Corresponding <strong>Graphic Layer</strong>.</li><li><strong>Annotation Details</strong> (description, rendering order, color, applicable images).</li></ul></li><li>Extracts and processes: <ul><li><strong>Text Objects</strong> (<code>x00700008</code>) using <code>retrieveTextObjectDetails</code>.</li><li><strong>Graphic Objects</strong> (<code>x00700009</code>) using <code>retrieveGraphicObjectDetails</code>.</li><li><strong>Compound Graphic Objects</strong> (<code>x00700209</code>) using <code>retrieveCompoundObjectDetails</code>.</li></ul></li></ol><hr><h5 id="retrievetextobjectdetails" tabindex="-1"><a class="header-anchor" href="#retrievetextobjectdetails"><span><code>retrieveTextObjectDetails</code></span></a></h5><p>Extracts text annotation details, including position, bounding box, and text style.</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">function</span> <span class="token function">retrieveTextObjectDetails</span><span class="token punctuation">(</span></span>
<span class="line">  textObject<span class="token operator">:</span> MetaData<span class="token punctuation">,</span></span>
<span class="line">  annotation<span class="token operator">:</span> AnnotationDetails<span class="token punctuation">,</span></span>
<span class="line">  toolAnnotations<span class="token operator">:</span> ToolAnnotations</span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Implementation Details</strong>:</p><ol><li>Extracts text position, bounding box, and anchor point.</li><li>Retrieves text formatting details (font, color, alignment, shadow properties).</li><li>Stores extracted data in <code>toolAnnotations</code> via <code>setToolAnnotationsAndOverlays</code>.</li></ol><hr><h5 id="retrievegraphicobjectdetails" tabindex="-1"><a class="header-anchor" href="#retrievegraphicobjectdetails"><span><code>retrieveGraphicObjectDetails</code></span></a></h5><p>Extracts graphic annotation details (e.g., lines, shapes) for display.</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">function</span> <span class="token function">retrieveGraphicObjectDetails</span><span class="token punctuation">(</span></span>
<span class="line">  graphicObject<span class="token operator">:</span> MetaData<span class="token punctuation">,</span></span>
<span class="line">  annotation<span class="token operator">:</span> AnnotationDetails<span class="token punctuation">,</span></span>
<span class="line">  toolAnnotations<span class="token operator">:</span> ToolAnnotations</span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Implementation Details</strong>:</p><ol><li>Extracts graphic properties (dimensions, points, type, fill status).</li><li>Retrieves line style details (thickness, pattern, shadow effects).</li><li>Stores extracted data in <code>toolAnnotations</code> using <code>setToolAnnotationsAndOverlays</code>.</li></ol><hr><h5 id="retrievecompoundobjectdetails" tabindex="-1"><a class="header-anchor" href="#retrievecompoundobjectdetails"><span><code>retrieveCompoundObjectDetails</code></span></a></h5><p>Processes complex annotations that include rotation, major ticks, and detailed line styles.</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">function</span> <span class="token function">retrieveCompoundObjectDetails</span><span class="token punctuation">(</span></span>
<span class="line">  compoundObject<span class="token operator">:</span> MetaData<span class="token punctuation">,</span></span>
<span class="line">  annotation<span class="token operator">:</span> AnnotationDetails<span class="token punctuation">,</span></span>
<span class="line">  toolAnnotations<span class="token operator">:</span> ToolAnnotations</span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Implementation Details</strong>:</p><ol><li>Extracts additional properties such as <strong>rotation angle</strong>, <strong>tick marks</strong>, and <strong>line styles</strong>.</li><li>Structures the extracted details.</li><li>Stores extracted data using <code>setToolAnnotationsAndOverlays</code>.</li></ol><hr><h5 id="findgraphiclayer" tabindex="-1"><a class="header-anchor" href="#findgraphiclayer"><span><code>findGraphicLayer</code></span></a></h5><p>Finds and returns the graphic layer matching a given annotation ID from <code>graphicLayers</code>.</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">function</span> <span class="token function">findGraphicLayer</span><span class="token punctuation">(</span>annotationID<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> graphicLayers<span class="token operator">?</span><span class="token operator">:</span> MetaData<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>Implementation Details</strong>:</p><ul><li>Iterates through <code>graphicLayers</code> and returns the matching layer.</li></ul><hr><h5 id="settoolannotationsandoverlays" tabindex="-1"><a class="header-anchor" href="#settoolannotationsandoverlays"><span><code>setToolAnnotationsAndOverlays</code></span></a></h5><p>Inserts annotation data into <code>toolAnnotations</code> in the correct rendering order.</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">function</span> <span class="token function">setToolAnnotationsAndOverlays</span><span class="token punctuation">(</span></span>
<span class="line">  newData<span class="token operator">:</span> MergedDetails<span class="token punctuation">,</span></span>
<span class="line">  toolAnnotations<span class="token operator">:</span> ToolAnnotations</span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Implementation Details</strong>:</p><ol><li>Determines the correct position based on rendering order.</li><li>Inserts the new annotation at the determined position.</li></ol><hr><h5 id="retrieveoverlaytooldata" tabindex="-1"><a class="header-anchor" href="#retrieveoverlaytooldata"><span><code>retrieveOverlayToolData</code></span></a></h5><p>Extracts and structures overlay data (e.g., ROIs, labels, descriptions) from DICOM metadata.</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">function</span> <span class="token function">retrieveOverlayToolData</span><span class="token punctuation">(</span></span>
<span class="line">  metadata<span class="token operator">:</span> MetaData<span class="token punctuation">,</span></span>
<span class="line">  toolAnnotations<span class="token operator">:</span> ToolAnnotations<span class="token punctuation">,</span></span>
<span class="line">  graphicGroups<span class="token operator">?</span><span class="token operator">:</span> MetaData<span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Implementation Details</strong>:</p><ol><li>Extracts <strong>presentation value</strong>, <strong>overlay color</strong>, and <strong>shutter shape</strong>.</li><li>Retrieves overlay-specific metadata (rows, columns, origin, type, etc.).</li><li>Converts <strong>CIELab color values</strong> to <strong>RGB</strong>.</li><li>Structures the overlay data and inserts it into <code>toolAnnotations</code> using <code>setToolAnnotationsAndOverlays</code>.</li></ol><h4 id="render-annotations-on-image" tabindex="-1"><a class="header-anchor" href="#render-annotations-on-image"><span>Render Annotations on Image</span></a></h4><h5 id="rendergraphicannotation" tabindex="-1"><a class="header-anchor" href="#rendergraphicannotation"><span><code>renderGraphicAnnotation</code></span></a></h5><p>Renders different types of graphic annotations (POINT, POLYLINE, CIRCLE, ELLIPSE) on the canvas, adhering to DICOM graphic layer module (0070,0020) and annotation sequences.</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">function</span> <span class="token function">renderGraphicAnnotation</span><span class="token punctuation">(</span></span>
<span class="line">  graphicObject<span class="token operator">:</span> GraphicDetails<span class="token punctuation">,</span></span>
<span class="line">  context<span class="token operator">:</span> CanvasRenderingContext2D<span class="token punctuation">,</span></span>
<span class="line">  element<span class="token operator">:</span> HTMLElement<span class="token punctuation">,</span></span>
<span class="line">  color<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span></span>
<span class="line">  viewport<span class="token operator">:</span> ViewportComplete<span class="token punctuation">,</span></span>
<span class="line">  image<span class="token operator">:</span> Image</span>
<span class="line">  <span class="token comment">//angle: number</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Implementation Details</strong></p><ul><li>The function extracts viewport transformation parameters such as <code>xMultiplier</code>, <code>yMultiplier</code>, <code>xScope</code>, and <code>yScope</code>.</li><li>If <code>lineStyleSequence</code> exists, it sets the appropriate line width, shadow color, and opacity.</li><li>Based on the <code>graphicType</code>, it applies different rendering logic: <ol><li><strong>POINT</strong>: Uses <code>fillRect</code> to render a small point.</li><li><strong>POLYLINE</strong>: Iterates through <code>graphicData</code>, applies transformation, and connects points using <code>moveTo</code> and <code>lineTo</code>.</li><li><strong>INTERPOLATED</strong>: Similar to <code>POLYLINE</code>, but applies interpolation between points.</li><li><strong>CIRCLE</strong>: Computes the radius from given points and uses <code>arc</code> to draw a circle.</li><li><strong>ELLIPSE</strong>: Computes transformed coordinates and utilizes <code>drawEllipse</code> for rendering.</li></ol></li></ul><h5 id="rendertextannotation" tabindex="-1"><a class="header-anchor" href="#rendertextannotation"><span><code>renderTextAnnotation</code></span></a></h5><p>This function renders a text annotation on the canvas, including its bounding box. It calculates the correct position and size based on viewport and image dimensions.</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">renderTextAnnotation</span><span class="token punctuation">(</span></span>
<span class="line">  textObject<span class="token operator">:</span> TextDetails<span class="token punctuation">,</span></span>
<span class="line">  context<span class="token operator">:</span> CanvasRenderingContext2D<span class="token punctuation">,</span></span>
<span class="line">  color<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span></span>
<span class="line">  element<span class="token operator">:</span> HTMLElement<span class="token punctuation">,</span></span>
<span class="line">  image<span class="token operator">:</span> Image<span class="token punctuation">,</span></span>
<span class="line">  viewport<span class="token operator">:</span> ViewportComplete</span>
<span class="line"><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Implementation Details</strong></p><ol><li><strong>Viewport Calculations</strong>: <ul><li>The function first calculates the <code>xMultiplier</code>, <code>yMultiplier</code>, <code>xScope</code>, and <code>yScope</code> based on the displayed area of the viewport to ensure proper scaling and positioning of the annotation.</li></ul></li><li><strong>Apply Pixel to Canvas</strong>: <ul><li>The <code>applyPixelToCanvas</code> function is used to adjust the position and scale of the text annotation relative to the canvas coordinates. It takes into account the bounding box and anchor point of the text.</li></ul></li><li><strong>Text Alignment</strong>: <ul><li>The function determines whether the text is centered on its anchor points or aligned based on the bounding box. The text position (<code>textX</code> and <code>textY</code>) is adjusted based on this alignment.</li></ul></li><li><strong>Text Drawing</strong>: <ul><li>The function draws the text on the canvas at the calculated position (<code>textX</code>, <code>textY</code>) using the specified font and color.</li></ul></li><li><strong>Bounding Box Drawing</strong>: <ul><li>A bounding box is drawn around the text annotation based on the calculated width and height.</li></ul></li><li><strong>Anchor Point Link</strong>: <ul><li>If the anchor point is visible, a line is drawn from the anchor point to the center of the bounding box to represent the link between the text and its anchor point.</li></ul></li></ol><h5 id="rendercompoundannotation" tabindex="-1"><a class="header-anchor" href="#rendercompoundannotation"><span><code>renderCompoundAnnotation</code></span></a></h5><p>Renders different types of compound annotation: (ELLIPSE, RECTANGLE, ARROW, MULTILINE, INFINITELINE, AXIS, RANGELINE, CUTLINE, RULER, CROSSHAIR) on the canvas, adhering to DICOM graphic layer module (0070,0020) and annotation sequences.</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">renderCompoundAnnotation</span><span class="token punctuation">(</span></span>
<span class="line">  compoundObject<span class="token operator">:</span> CompoundDetails<span class="token punctuation">,</span></span>
<span class="line">  context<span class="token operator">:</span> CanvasRenderingContext2D<span class="token punctuation">,</span></span>
<span class="line">  element<span class="token operator">:</span> HTMLElement<span class="token punctuation">,</span></span>
<span class="line">  color<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span></span>
<span class="line">  viewport<span class="token operator">:</span> ViewportComplete<span class="token punctuation">,</span></span>
<span class="line">  image<span class="token operator">:</span> Image</span>
<span class="line">  <span class="token comment">//angle: number</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Implementation Details</strong></p><p>This function can render several different types of annotations based on the <code>graphicType</code> specified in the <code>compoundObject</code>. The following types are supported:</p><ol><li><strong>ELLIPSE</strong>: Renders an ellipse. The ellipse coordinates are calculated, optionally rotated, and drawn on the canvas. Optionally, the ellipse can be filled based on the <code>graphicFilled</code> property.</li><li><strong>RECTANGLE</strong>: Renders a rectangle. Similar to the ellipse, rectangle coordinates are calculated, rotated, and drawn. It also supports filled rectangles.</li><li><strong>ARROW</strong>: Renders an arrow. Arrow handles are calculated, rotated, and drawn with optional dashed lines. The arrow is drawn between the start and end handles, and optionally, a midpoint is used.</li><li><strong>MULTILINE</strong>: Renders multiple line segments. Each segment is processed and drawn as a line between start and end handles, with rotation applied as necessary.</li><li><strong>INFINITELINE</strong>: Renders a line that extends infinitely in both directions. The line is drawn between two handles, and any intersections with the image boundaries are detected and drawn with dashed lines.</li><li><strong>CUTLINE</strong>: Renders a cutline, which is a line drawn between two handles with optional rotation. It also includes additional visualization options like gaps in the line.</li><li><strong>RANGELINE</strong>: Renders a range line, which is a line between two points with perpendicular ticks at each endpoint. These ticks are visualized based on the <code>tickLength</code> property.</li><li><strong>RULER</strong>: Renders a ruler annotation, which is a line that includes major ticks. The ticks are drawn along the ruler, with labels positioned based on the provided alignment.</li><li><strong>AXIS</strong>: Similar to the ruler, but typically used for visualizing axes in an image or data visualization context. Includes major ticks and customizable tick alignment.</li><li><strong>CROSSHAIR</strong>: Renders a crosshair annotation at a given origin point. It supports diameter visibility and optional gap length, drawing vertical and horizontal lines through the origin.</li></ol><p><strong>Notes</strong></p><ul><li><strong>Rotation</strong>: For some annotation types (e.g., arrow, ellipse, rectangle), rotation can be applied using the <code>rotationAngle</code> and <code>rotationPoint</code> properties. Rotation is performed around the defined rotation point.</li><li><strong>Shadow and Line Style</strong>: The function supports advanced line styling, including shadow effects. The shadow&#39;s color, opacity, and offset can be defined through the <code>lineStyleSequence</code>.</li><li><strong>Pixel to Canvas Transformation</strong>: Coordinates are transformed from image space to canvas space using the <code>applyPixelToCanvas</code> function, which ensures that annotations are properly scaled and positioned on the canvas based on the current viewport.</li><li><strong>Customizable Line Styles</strong>: Annotations such as arrows and lines can have customizable line thickness and dashing styles.</li></ul><h5 id="renderoverlay" tabindex="-1"><a class="header-anchor" href="#renderoverlay"><span><code>renderOverlay</code></span></a></h5><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">renderOverlay</span><span class="token punctuation">(</span>data<span class="token operator">:</span> AnnotationOverlay<span class="token punctuation">,</span> image<span class="token operator">:</span> Image<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>Implementation Details</strong></p><ul><li><strong>Visibility Check:</strong> The function starts by checking if the overlay is visible (data.visible). If the overlay is not visible, the function returns early and does not render anything.</li><li><strong>Creating a Canvas for Overlay:</strong> A new canvas element (layerCanvas) is created, and its dimensions are set to match the image size. This canvas is used to draw the overlay. A 2D rendering context (layerContext) is obtained from the layerCanvas.</li><li><strong>Filling the Overlay:</strong> If the overlay type is &quot;R&quot;, the entire canvas is filled with the fill color using fillRect(). The globalCompositeOperation is set to &quot;xor&quot;, which means the subsequent drawing operations will use an XOR blend mode.</li><li><strong>Rendering Pixel Data:</strong> The pixelData array is iterated over, and for each non-zero value, a small rectangle (1x1 pixel) is drawn at the corresponding (x, y) position on the canvas.</li><li><strong>Positioning the Overlay:</strong> The x and y coordinates for the overlay are validated to ensure they are finite numbers. If they are invalid or missing, they default to 0.</li><li><strong>Drawing the Overlay on the Image:</strong> The overlay layer is drawn onto the image canvas using the drawImage() method. The overlay is positioned at the specified x and y coordinates.</li></ul><h3 id="apply-lut-changes-on-image" tabindex="-1"><a class="header-anchor" href="#apply-lut-changes-on-image"><span>Apply LUT changes on Image</span></a></h3><h4 id="applymodalitylut" tabindex="-1"><a class="header-anchor" href="#applymodalitylut"><span><code>applyModalityLUT</code></span></a></h4><p>Applies the Modality LUT or rescale operation to map stored pixel values to meaningful output values using DICOM attributes (x00283000, x00281052, x00281053). Handles both LUT Sequence and linear rescale.</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token function">applyModalityLUT</span><span class="token punctuation">(</span></span>
<span class="line">  metadata<span class="token operator">:</span> MetaData<span class="token punctuation">,</span></span>
<span class="line">  image<span class="token operator">:</span> ImageParameters<span class="token punctuation">,</span></span>
<span class="line">  viewport<span class="token operator">:</span> Viewport</span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Implementation Details</strong></p><ul><li>If the modality LUT sequence is present in the metadata, the LUT is applied by calling the setLUT function.</li><li>If no LUT is found but both slope and intercept are provided, the rescale operation is applied to the image.</li></ul><h4 id="applysoftcopylut" tabindex="-1"><a class="header-anchor" href="#applysoftcopylut"><span><code>applySoftcopyLUT</code></span></a></h4><p>Applies the Softcopy VOI LUT (Window Width and Window Center) to the viewport based on the DICOM metadata (attributes: x00281050, x00281051, x00283010). Handles both explicit VOI LUT Sequence and window settings.</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token function">applySoftcopyLUT</span><span class="token punctuation">(</span>metadata<span class="token operator">:</span> MetaData<span class="token punctuation">,</span> viewport<span class="token operator">:</span> Viewport<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>Implementation Details</strong></p><ul><li>If VOI LUT Sequence is available, the first LUT in the sequence is applied to the viewport by calling the setLUT function.</li><li>If VOI LUT Sequence is absent, the window width and window center are extracted from the metadata and applied directly to the viewport.</li></ul><h4 id="applysoftcopypresentationlut" tabindex="-1"><a class="header-anchor" href="#applysoftcopypresentationlut"><span><code>applySoftcopyPresentationLUT</code></span></a></h4><p>Applies the Presentation LUT Sequence or shape to the viewport, modifying the display output as per DICOM attributes (x20500010, x20500020). Supports both LUT application and inversion logic.</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token function">applySoftcopyPresentationLUT</span><span class="token punctuation">(</span></span>
<span class="line">  metadata<span class="token operator">:</span> MetaData<span class="token punctuation">,</span></span>
<span class="line">  viewport<span class="token operator">:</span> Viewport</span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Implementation Details</strong></p><ul><li>If Presentation LUT Sequence is available, the first LUT in the sequence is applied to the viewport by calling the setLUT function.</li><li>If Presentation LUT Sequence is not found and the Presentation LUT Shape is &quot;INVERSE&quot;, the invert property of the viewport is set to true.</li></ul><h3 id="apply-masks-on-image" tabindex="-1"><a class="header-anchor" href="#apply-masks-on-image"><span>Apply Masks on Image</span></a></h3><h4 id="retrievedisplayshutter" tabindex="-1"><a class="header-anchor" href="#retrievedisplayshutter"><span><code>retrieveDisplayShutter</code></span></a></h4><p>Retrieves and applies a display shutter based on DICOM metadata, supporting rectangular, circular, and polygonal shutters (shape x00181600).</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token function">retrieveDisplayShutter</span><span class="token punctuation">(</span></span>
<span class="line">  metadata<span class="token operator">:</span> MetaData<span class="token punctuation">,</span></span>
<span class="line">  viewport<span class="token operator">:</span> Viewport</span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Implementation Details</strong></p><ul><li>The function checks for the shutter shape in the metadata and applies the appropriate shutter type: <strong>Rectangular:</strong> Draws a rectangular shutter using edges defined in the metadata. <strong>Circular:</strong> Draws a circular shutter based on the center and radius from the metadata. <strong>Polygonal:</strong> Draws a polygonal shutter using vertices from the metadata.</li><li>Shutter Color: The shutter color is derived from the DICOM metadata (using CIELab to RGB conversion if needed).</li></ul><h4 id="applymask" tabindex="-1"><a class="header-anchor" href="#applymask"><span><code>applyMask</code></span></a></h4><p>Enables and updates the Digital Subtraction Angiography (DSA) mask on multi-frame series, ensuring the appropriate frame is displayed.</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token function">applyMask</span><span class="token punctuation">(</span>serie<span class="token operator">:</span> Series<span class="token punctuation">,</span> element<span class="token operator">:</span> HTMLElement<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>Implementation Details</strong></p><ul><li>If the series is a multi-frame series, this function updates the DSA mask and ensures the correct frame is displayed.</li><li>It fetches the current frame ID and sets the DSA mask to be enabled. See <a class="route-link" href="/api/modules/postProcessing/dsa.html">DSA</a>.</li></ul><h3 id="apply-spatial-transformations-on-image" tabindex="-1"><a class="header-anchor" href="#apply-spatial-transformations-on-image"><span>Apply spatial transformations on Image</span></a></h3><h4 id="applyspatialtransformation" tabindex="-1"><a class="header-anchor" href="#applyspatialtransformation"><span><code>applySpatialTransformation</code></span></a></h4><p>Applies spatial transformations like rotation and flipping to the viewport using the DICOM Graphic Layer Module (x00700041, x00700042), considering initial rotation and flip settings.</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token function">applySpatialTransformation</span><span class="token punctuation">(</span></span>
<span class="line">  metadata<span class="token operator">:</span> MetaData<span class="token punctuation">,</span></span>
<span class="line">  viewport<span class="token operator">:</span> ViewportComplete</span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Implementation Details</strong></p><ul><li><strong>Rotation:</strong> The function checks for an angle value in the metadata and adjusts the viewport&#39;s rotation accordingly. If the viewport has an initial rotation set, that is taken into account before applying the angle from the metadata.</li><li><strong>Flipping:</strong> It handles horizontal and vertical flipping based on the metadata values. The flip behavior is adjusted if the rotation angle is 90, 180, or 270 degrees.</li></ul><h4 id="applyzoompan" tabindex="-1"><a class="header-anchor" href="#applyzoompan"><span><code>applyZoomPan</code></span></a></h4><p>Applies zoom and pan transformations to the viewport based on the DICOM Displayed Area Selection Sequence (x0070005a). Handles pixel origin interpretation, top-left/bottom-right coordinates, pixel spacing, and magnification.</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts" data-title="ts"><pre><code><span class="line"><span class="token function">applyZoomPan</span><span class="token punctuation">(</span></span>
<span class="line">  metadata<span class="token operator">:</span> MetaData<span class="token punctuation">,</span></span>
<span class="line">  viewport<span class="token operator">:</span> ViewportComplete<span class="token punctuation">,</span></span>
<span class="line">  element<span class="token operator">:</span> HTMLElement</span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Implementation Details</strong></p><ul><li><strong>Displayed Area:</strong> The function extracts the Displayed Area Selection Sequence (x0070005a) from the metadata and interprets the top-left and bottom-right coordinates.</li><li><strong>Pixel Origin Interpretation:</strong> It checks whether the pixel origin interpretation is VOLUME or FRAME, adjusting the coordinates accordingly.</li><li><strong>Presentation Size Mode:</strong> It manages the presentation size and magnification ratio, modifying the viewport scale based on the DICOM data.</li><li><strong>Pixel Spacing and Aspect Ratio:</strong> The function handles pixel spacing and aspect ratio adjustments if specified in the metadata.</li></ul><h2 id="conclusion" tabindex="-1"><a class="header-anchor" href="#conclusion"><span>Conclusion</span></a></h2><p><code>GspsTool</code> is a powerful extension for medical image viewers, enabling proper visualization of transformations, annotations and overlays based on GSPS metadata. It leverages Cornerstones rendering capabilities to provide an accurate representation of medical images and associated presentation states.</p><p><br></p><div style="text-align:center;"><img src="https://press.r1-it.storage.cloud.it/logo_trasparent.png" alt="D/Vision Lab" height="200"></div> ```` </div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="vp-meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 146220917+laura-borghesi-lum00n@users.noreply.github.com">Laura Borghesi</span><!----><!--]--><!--]--></span></div></div></footer><nav class="vp-page-nav" aria-label="page navigation"><a class="route-link auto-link prev" href="/api/modules/visualizations/colorMaps.html" aria-label="Color Maps"><div class="hint"><span class="arrow left"></span> Prev</div><div class="link"><span>Color Maps</span></div></a><!----></nav><!--[--><!--]--></main><!--]--></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-BVwHBcsb.js" defer></script>
  </body>
</html>
